<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>go 语言圣经 | tangdw</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/logo.jpg">
    <link rel="manifest" href="/manifest.json">
    <meta name="description" content="">
    <meta name="theme-color" content="#f22148">
    
    <link rel="preload" href="/assets/css/0.styles.3f503044.css" as="style"><link rel="preload" href="/assets/js/app.da05fdbf.js" as="script"><link rel="preload" href="/assets/js/2.208295da.js" as="script"><link rel="preload" href="/assets/js/33.362b0b71.js" as="script"><link rel="preload" href="/assets/js/5.b3cdef39.js" as="script"><link rel="prefetch" href="/assets/js/10.874c21b1.js"><link rel="prefetch" href="/assets/js/11.06584f03.js"><link rel="prefetch" href="/assets/js/12.a5c8c05f.js"><link rel="prefetch" href="/assets/js/13.1b507851.js"><link rel="prefetch" href="/assets/js/14.c27a0ed9.js"><link rel="prefetch" href="/assets/js/15.fae66cfd.js"><link rel="prefetch" href="/assets/js/16.8b83fc5b.js"><link rel="prefetch" href="/assets/js/17.eafc6cc3.js"><link rel="prefetch" href="/assets/js/18.f7675d14.js"><link rel="prefetch" href="/assets/js/19.aa19b35f.js"><link rel="prefetch" href="/assets/js/20.af217273.js"><link rel="prefetch" href="/assets/js/21.8ddc378c.js"><link rel="prefetch" href="/assets/js/22.36e77ad8.js"><link rel="prefetch" href="/assets/js/23.5a61c462.js"><link rel="prefetch" href="/assets/js/24.582c1b00.js"><link rel="prefetch" href="/assets/js/25.eda3379a.js"><link rel="prefetch" href="/assets/js/26.8e4cbbe9.js"><link rel="prefetch" href="/assets/js/27.03cb3422.js"><link rel="prefetch" href="/assets/js/28.645ce61e.js"><link rel="prefetch" href="/assets/js/29.f897465a.js"><link rel="prefetch" href="/assets/js/3.967895da.js"><link rel="prefetch" href="/assets/js/30.d2934177.js"><link rel="prefetch" href="/assets/js/31.42258174.js"><link rel="prefetch" href="/assets/js/32.f7b5e341.js"><link rel="prefetch" href="/assets/js/34.91512baa.js"><link rel="prefetch" href="/assets/js/35.e51fc052.js"><link rel="prefetch" href="/assets/js/36.41c20116.js"><link rel="prefetch" href="/assets/js/37.e90f6066.js"><link rel="prefetch" href="/assets/js/38.3878636b.js"><link rel="prefetch" href="/assets/js/39.f310c7d2.js"><link rel="prefetch" href="/assets/js/4.9f3812bd.js"><link rel="prefetch" href="/assets/js/40.c1e2ee49.js"><link rel="prefetch" href="/assets/js/41.cf733c7c.js"><link rel="prefetch" href="/assets/js/42.ef868d9d.js"><link rel="prefetch" href="/assets/js/43.8478bfa6.js"><link rel="prefetch" href="/assets/js/44.dd9a1d85.js"><link rel="prefetch" href="/assets/js/45.d014f7a8.js"><link rel="prefetch" href="/assets/js/46.205be7a4.js"><link rel="prefetch" href="/assets/js/47.a942e446.js"><link rel="prefetch" href="/assets/js/48.f11dc1c7.js"><link rel="prefetch" href="/assets/js/49.30f1d0d9.js"><link rel="prefetch" href="/assets/js/50.ad3da487.js"><link rel="prefetch" href="/assets/js/51.6685e327.js"><link rel="prefetch" href="/assets/js/52.6f6c68f4.js"><link rel="prefetch" href="/assets/js/53.4acba881.js"><link rel="prefetch" href="/assets/js/54.609dd144.js"><link rel="prefetch" href="/assets/js/6.b8f3f640.js"><link rel="prefetch" href="/assets/js/7.2e8acf8c.js"><link rel="prefetch" href="/assets/js/8.cd73e5c7.js"><link rel="prefetch" href="/assets/js/9.ba0911e0.js">
    <link rel="stylesheet" href="/assets/css/0.styles.3f503044.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">tangdw</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/书签.html" class="nav-link">
  Blog
</a></div><div class="nav-item"><a href="/shell.html" class="nav-link">
  Shell
</a></div><div class="nav-item"><a href="/nestjs.html" class="nav-link">
  Nestjs
</a></div><div class="nav-item"><a href="/golang.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  golang
</a></div><div class="nav-item"><a href="/life/传习录.html" class="nav-link">
  My Life
</a></div> <a href="https://github.com/tangdw" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/书签.html" class="nav-link">
  Blog
</a></div><div class="nav-item"><a href="/shell.html" class="nav-link">
  Shell
</a></div><div class="nav-item"><a href="/nestjs.html" class="nav-link">
  Nestjs
</a></div><div class="nav-item"><a href="/golang.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  golang
</a></div><div class="nav-item"><a href="/life/传习录.html" class="nav-link">
  My Life
</a></div> <a href="https://github.com/tangdw" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>go 语言圣经</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/golang.html#前言" class="sidebar-link">前言</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/golang.html#入门" class="sidebar-link">入门</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/golang.html#程序结构" class="sidebar-link">程序结构</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/golang.html#命名" class="sidebar-link">命名</a></li><li class="sidebar-sub-header"><a href="/golang.html#声明" class="sidebar-link">声明</a></li><li class="sidebar-sub-header"><a href="/golang.html#变量" class="sidebar-link">变量</a></li><li class="sidebar-sub-header"><a href="/golang.html#赋值" class="sidebar-link">赋值</a></li><li class="sidebar-sub-header"><a href="/golang.html#类型" class="sidebar-link">类型</a></li><li class="sidebar-sub-header"><a href="/golang.html#包和文件" class="sidebar-link">包和文件</a></li><li class="sidebar-sub-header"><a href="/golang.html#作用域" class="sidebar-link">作用域</a></li></ul></li><li><a href="/golang.html#基础数据类型" class="sidebar-link">基础数据类型</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/golang.html#复合数据类型" class="sidebar-link">复合数据类型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/golang.html#数组" class="sidebar-link">数组</a></li><li class="sidebar-sub-header"><a href="/golang.html#slice-切片" class="sidebar-link">slice 切片</a></li><li class="sidebar-sub-header"><a href="/golang.html#map" class="sidebar-link">Map</a></li><li class="sidebar-sub-header"><a href="/golang.html#结构体" class="sidebar-link">结构体</a></li><li class="sidebar-sub-header"><a href="/golang.html#json" class="sidebar-link">JSON</a></li><li class="sidebar-sub-header"><a href="/golang.html#文本和-html-模板" class="sidebar-link">文本和 HTML 模板</a></li></ul></li><li><a href="/golang.html#函数" class="sidebar-link">函数</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/golang.html#函数声明" class="sidebar-link">函数声明</a></li><li class="sidebar-sub-header"><a href="/golang.html#递归" class="sidebar-link">递归</a></li><li class="sidebar-sub-header"><a href="/golang.html#多返回值" class="sidebar-link">多返回值</a></li><li class="sidebar-sub-header"><a href="/golang.html#错误" class="sidebar-link">错误</a></li><li class="sidebar-sub-header"><a href="/golang.html#函数值" class="sidebar-link">函数值</a></li><li class="sidebar-sub-header"><a href="/golang.html#匿名函数" class="sidebar-link">匿名函数</a></li><li class="sidebar-sub-header"><a href="/golang.html#可变参数" class="sidebar-link">可变参数</a></li><li class="sidebar-sub-header"><a href="/golang.html#deferred-函数" class="sidebar-link">Deferred 函数</a></li><li class="sidebar-sub-header"><a href="/golang.html#panic-异常" class="sidebar-link">Panic 异常</a></li><li class="sidebar-sub-header"><a href="/golang.html#recover-捕获异常" class="sidebar-link">Recover 捕获异常</a></li></ul></li><li><a href="/golang.html#方法" class="sidebar-link">方法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/golang.html#方法声明" class="sidebar-link">方法声明</a></li><li class="sidebar-sub-header"><a href="/golang.html#基于指针的对象方法" class="sidebar-link">基于指针的对象方法</a></li><li class="sidebar-sub-header"><a href="/golang.html#通过嵌入结构体来扩展类型" class="sidebar-link">通过嵌入结构体来扩展类型</a></li><li class="sidebar-sub-header"><a href="/golang.html#方法值-和-方法表达式" class="sidebar-link">方法值 和 方法表达式</a></li><li class="sidebar-sub-header"><a href="/golang.html#bit-数组" class="sidebar-link">Bit 数组</a></li><li class="sidebar-sub-header"><a href="/golang.html#封装" class="sidebar-link">封装</a></li></ul></li><li><a href="/golang.html#接口" class="sidebar-link">接口</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/golang.html#接口约定" class="sidebar-link">接口约定</a></li><li class="sidebar-sub-header"><a href="/golang.html#接口类型" class="sidebar-link">接口类型</a></li><li class="sidebar-sub-header"><a href="/golang.html#实现接口的条件" class="sidebar-link">实现接口的条件</a></li><li class="sidebar-sub-header"><a href="/golang.html#标准的接口类型-flag-value" class="sidebar-link">标准的接口类型 flag.Value</a></li><li class="sidebar-sub-header"><a href="/golang.html#接口值" class="sidebar-link">接口值</a></li><li class="sidebar-sub-header"><a href="/golang.html#sort-interface-接口" class="sidebar-link">sort.Interface 接口</a></li><li class="sidebar-sub-header"><a href="/golang.html#http-handler-接口" class="sidebar-link">http.Handler 接口</a></li><li class="sidebar-sub-header"><a href="/golang.html#error-接口" class="sidebar-link">error 接口</a></li><li class="sidebar-sub-header"><a href="/golang.html#表达式求值" class="sidebar-link">表达式求值</a></li><li class="sidebar-sub-header"><a href="/golang.html#类型断言" class="sidebar-link">类型断言</a></li><li class="sidebar-sub-header"><a href="/golang.html#基于类型断言区别错误类型" class="sidebar-link">基于类型断言区别错误类型</a></li><li class="sidebar-sub-header"><a href="/golang.html#通过类型断言询问行为" class="sidebar-link">通过类型断言询问行为</a></li><li class="sidebar-sub-header"><a href="/golang.html#类型分支" class="sidebar-link">类型分支</a></li><li class="sidebar-sub-header"><a href="/golang.html#基于标记的-xml-解码" class="sidebar-link">基于标记的 XML 解码</a></li></ul></li><li><a href="/golang.html#goroutines-和-channels" class="sidebar-link">Goroutines 和 Channels</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/golang.html#goroutines" class="sidebar-link">Goroutines</a></li><li class="sidebar-sub-header"><a href="/golang.html#channels" class="sidebar-link">Channels</a></li><li class="sidebar-sub-header"><a href="/golang.html#并发的循环" class="sidebar-link">并发的循环</a></li><li class="sidebar-sub-header"><a href="/golang.html#并发的-web-爬虫" class="sidebar-link">并发的 Web 爬虫</a></li><li class="sidebar-sub-header"><a href="/golang.html#基于-select-的多路复用" class="sidebar-link">基于 select 的多路复用</a></li><li class="sidebar-sub-header"><a href="/golang.html#并发的目录遍历" class="sidebar-link">并发的目录遍历</a></li><li class="sidebar-sub-header"><a href="/golang.html#并发的退出" class="sidebar-link">并发的退出</a></li><li class="sidebar-sub-header"><a href="/golang.html#聊天服务" class="sidebar-link">聊天服务</a></li></ul></li><li><a href="/golang.html#基于共享变量的并发" class="sidebar-link">基于共享变量的并发</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/golang.html#竞争条件" class="sidebar-link">竞争条件</a></li><li class="sidebar-sub-header"><a href="/golang.html#sync-mutex-互斥锁" class="sidebar-link">sync.Mutex 互斥锁</a></li><li class="sidebar-sub-header"><a href="/golang.html#sync-rwmutex-读写锁" class="sidebar-link">sync.RWMutex 读写锁</a></li><li class="sidebar-sub-header"><a href="/golang.html#内存同步" class="sidebar-link">内存同步</a></li><li class="sidebar-sub-header"><a href="/golang.html#sync-once-惰性初始化" class="sidebar-link">sync.Once 惰性初始化</a></li><li class="sidebar-sub-header"><a href="/golang.html#竞争条件检测" class="sidebar-link">竞争条件检测</a></li><li class="sidebar-sub-header"><a href="/golang.html#并发的非阻塞缓存" class="sidebar-link">并发的非阻塞缓存</a></li><li class="sidebar-sub-header"><a href="/golang.html#goroutines-和线程" class="sidebar-link">Goroutines 和线程</a></li></ul></li><li><a href="/golang.html#包和工具" class="sidebar-link">包和工具</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/golang.html#导入路径" class="sidebar-link">导入路径</a></li><li class="sidebar-sub-header"><a href="/golang.html#导入路径-2" class="sidebar-link">导入路径</a></li><li class="sidebar-sub-header"><a href="/golang.html#包的匿名导入" class="sidebar-link">包的匿名导入</a></li><li class="sidebar-sub-header"><a href="/golang.html#工具" class="sidebar-link">工具</a></li><li class="sidebar-sub-header"><a href="/golang.html#工作区结构" class="sidebar-link">工作区结构</a></li><li class="sidebar-sub-header"><a href="/golang.html#下载包" class="sidebar-link">下载包</a></li><li class="sidebar-sub-header"><a href="/golang.html#构建包" class="sidebar-link">构建包</a></li><li class="sidebar-sub-header"><a href="/golang.html#包文档" class="sidebar-link">包文档</a></li><li class="sidebar-sub-header"><a href="/golang.html#内部包" class="sidebar-link">内部包</a></li><li class="sidebar-sub-header"><a href="/golang.html#查询包" class="sidebar-link">查询包</a></li></ul></li><li><a href="/golang.html#测试" class="sidebar-link">测试</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/golang.html#随机测试" class="sidebar-link">随机测试</a></li><li class="sidebar-sub-header"><a href="/golang.html#白盒测试" class="sidebar-link">白盒测试</a></li><li class="sidebar-sub-header"><a href="/golang.html#外部测试包" class="sidebar-link">外部测试包</a></li><li class="sidebar-sub-header"><a href="/golang.html#测试覆盖率" class="sidebar-link">测试覆盖率</a></li><li class="sidebar-sub-header"><a href="/golang.html#基准测试" class="sidebar-link">基准测试</a></li><li class="sidebar-sub-header"><a href="/golang.html#剖析" class="sidebar-link">剖析</a></li><li class="sidebar-sub-header"><a href="/golang.html#示例函数" class="sidebar-link">示例函数</a></li></ul></li><li><a href="/golang.html#反射" class="sidebar-link">反射</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/golang.html#底层编程" class="sidebar-link">底层编程</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="go-语言圣经"><a href="#go-语言圣经" aria-hidden="true" class="header-anchor">#</a> go 语言圣经</h1> <h2 id="前言"><a href="#前言" aria-hidden="true" class="header-anchor">#</a> 前言</h2> <p>Go 从 C 语言继承了相似的表达式语法、控制流结构、基础数据类型、调用参数传值、指针</p> <p>拥有自动垃圾回收、一个包系统、函数作为一等公民、词法作用域、系统调用接口、只读的 UTF8 字符串</p> <p>没有隐式的数值转换，没有构造函数和析构函数，没有运算符重载，没有默认参数，也没有继承，没有泛型，没有异常，没有宏，没有函数修饰，更没有线程局部存储</p> <p>提供了基于顺序通信进程（CSP）的并发特性支持。Go 语言的动态栈使得轻量级线程 goroutine 的初始栈可以很小，因此，创建一个 goroutine 的代价很小，创建百万级的 goroutine 完全是可行的</p> <h2 id="入门"><a href="#入门" aria-hidden="true" class="header-anchor">#</a> 入门</h2> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// Echo1 prints its command-line arguments.</span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;fmt&quot;</span>
    <span class="token string">&quot;os&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> s<span class="token punctuation">,</span> sep <span class="token builtin">string</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Args<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        s <span class="token operator">+=</span> sep <span class="token operator">+</span> os<span class="token punctuation">.</span>Args<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        sep <span class="token operator">=</span> <span class="token string">&quot; &quot;</span>
    <span class="token punctuation">}</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><ul><li><p>var 声明定义了两个 string 类型的变量 s 和 sep。变量会在声明时直接初始化。如果变量没有显式初始化，则被隐式地赋予其类型的零值（zero value），数值类型是 0，字符串类型是空字符串&quot;&quot;。这个例子里，声明把 s 和 sep 隐式地初始化成空字符串</p></li> <li><p>符号 := 是短变量声明（short variable declaration）的一部分, 这是定义一个或多个变量并根据它们的初始值为这些变量赋予适当类型的语句。只能用在函数内部</p></li></ul> <h2 id="程序结构"><a href="#程序结构" aria-hidden="true" class="header-anchor">#</a> 程序结构</h2> <ul><li>一个大的程序是由很多小的基础构件组成</li> <li>变量保存值，简单的加法和减法运算被组合成较复杂的表达式</li> <li>基础类型被聚合为数组或结构体等更复杂的数据结构</li> <li>使用 if 和 for 之类的控制语句来组织和控制表达式的执行流程</li> <li>多个语句被组织到一个个函数中，以便代码的隔离和复用</li> <li>函数以源文件和包的方式被组织</li></ul> <h3 id="命名"><a href="#命名" aria-hidden="true" class="header-anchor">#</a> 命名</h3> <p><code>包级名字</code>以大写字母开头的，它将是导出的，也就是说可以被<code>外部的包</code>访问</p> <p>如果一个名字的作用域比较大，生命周期也比较长，那么用长的名字将会更有意义</p> <h3 id="声明"><a href="#声明" aria-hidden="true" class="header-anchor">#</a> 声明</h3> <p>var const type func</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// 包名声明</span>
<span class="token keyword">package</span> main
<span class="token comment">// 导入依赖</span>
<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>
<span class="token comment">// 包一级的各种声明（包一级的顺序无关紧要）</span>
<span class="token keyword">const</span> boilingF <span class="token operator">=</span> <span class="token number">212.0</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 但函数内部的名字则必须先声明之后才能使用</span>
    <span class="token keyword">var</span> f <span class="token operator">=</span> boilingF
    <span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token punctuation">(</span>f <span class="token operator">-</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">5</span> <span class="token operator">/</span> <span class="token number">9</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;boiling point = %g°F or %g°C\n&quot;</span><span class="token punctuation">,</span> f<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="变量"><a href="#变量" aria-hidden="true" class="header-anchor">#</a> 变量</h3> <p><code>var 变量名字 类型 = 表达式</code></p> <p>以下部分省略时
“类型” - 将根据初始化表达式来推导变量的类型信息
“= 表达式” - 将用<code>零值</code>（0 false '' nil）初始化该变量</p> <p><code>名字 := 表达式</code></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// 声明一组变量</span>
i<span class="token punctuation">,</span> j <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span>
in<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>infile<span class="token punctuation">)</span>
f<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>infile<span class="token punctuation">)</span> <span class="token comment">// 声明至少要有新的变量，已存在的变量是赋值行为</span>
f<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>outfile<span class="token punctuation">)</span> <span class="token comment">// 编译报错</span>
</code></pre></div><p><code>指针</code></p> <div class="language-go extra-class"><pre class="language-go"><code>x <span class="token operator">:=</span> <span class="token number">1</span>
<span class="token comment">// p 指针 指向 变量 x</span>
p <span class="token operator">:=</span> <span class="token operator">&amp;</span>x         <span class="token comment">// &amp;x 取 x 变量的地址，此时 `指针 p` 保存的是一个地址，对应的数据类型是 *int</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token comment">// *p 表达式 -&gt; 对应 p 指针指向的变量值</span>
<span class="token operator">*</span>p <span class="token operator">=</span> <span class="token number">2</span>          <span class="token comment">// x = 2</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>  <span class="token comment">// &quot;2&quot;</span>

</code></pre></div><p>指针的零值时 nil</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">var</span> x<span class="token punctuation">,</span> y <span class="token builtin">int</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>x <span class="token operator">==</span> <span class="token operator">&amp;</span>x<span class="token punctuation">,</span> <span class="token operator">&amp;</span>x <span class="token operator">==</span> <span class="token operator">&amp;</span>y<span class="token punctuation">,</span> <span class="token operator">&amp;</span>x <span class="token operator">==</span> <span class="token boolean">nil</span><span class="token punctuation">)</span> <span class="token comment">// &quot;true false false&quot;</span>
</code></pre></div><p>每次我们对一个变量取地址，或者复制指针，我们都是为原变量创建了新的别名</p> <p>很多其他引用类型也会创建别名，例如 slice、map 和 chan，甚至结构体、数组和接口都会创建所引用变量的别名</p> <p>new 函数 <code>new(T) *T</code> 并不是关键字</p> <div class="language-go extra-class"><pre class="language-go"><code>p <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>   <span class="token comment">// p, *int 类型, 指向匿名的 int 变量</span>
<span class="token comment">// var a int</span>
<span class="token comment">// p := &amp;a</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token comment">// 0 指定类型的零值</span>
<span class="token operator">*</span>p <span class="token operator">=</span> <span class="token number">2</span>          <span class="token comment">// 设置 int 匿名变量的值为 2</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token comment">// 2</span>
</code></pre></div><div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">for</span> t <span class="token operator">:=</span> <span class="token number">0.0</span><span class="token punctuation">;</span> t <span class="token operator">&lt;</span> cycles<span class="token operator">*</span><span class="token number">2</span><span class="token operator">*</span>math<span class="token punctuation">.</span>Pi<span class="token punctuation">;</span> t <span class="token operator">+=</span> res <span class="token punctuation">{</span>
    x <span class="token operator">:=</span> math<span class="token punctuation">.</span><span class="token function">Sin</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
    y <span class="token operator">:=</span> math<span class="token punctuation">.</span><span class="token function">Sin</span><span class="token punctuation">(</span>t<span class="token operator">*</span>freq <span class="token operator">+</span> phase<span class="token punctuation">)</span>
    img<span class="token punctuation">.</span><span class="token function">SetColorIndex</span><span class="token punctuation">(</span>
        size<span class="token operator">+</span><span class="token function">int</span><span class="token punctuation">(</span>x<span class="token operator">*</span>size<span class="token operator">+</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> size<span class="token operator">+</span><span class="token function">int</span><span class="token punctuation">(</span>y<span class="token operator">*</span>size<span class="token operator">+</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        blackIndex<span class="token punctuation">,</span> <span class="token comment">// 这里加逗号，避免编译器在行尾插分号</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="赋值"><a href="#赋值" aria-hidden="true" class="header-anchor">#</a> 赋值</h3> <p>数值变量 ++ 递增和 -- 递减语句（自增和自减是语句，而不是表达式，因此 x = i++ 之类的表达式是错误的）</p> <p>元组赋值</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">fib</span><span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
    x<span class="token punctuation">,</span> y <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        x<span class="token punctuation">,</span> y <span class="token operator">=</span> y<span class="token punctuation">,</span> x <span class="token operator">+</span> y
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> x
<span class="token punctuation">}</span>
</code></pre></div><h3 id="类型"><a href="#类型" aria-hidden="true" class="header-anchor">#</a> 类型</h3> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> 类型名字 底层类型
</code></pre></div><p>类型声明语句一般出现在包一级，因此如果新创建的类型名字的首字符大写，则在外部包也可以使用。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> tempconv

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">type</span> Celsius <span class="token builtin">float64</span>    <span class="token comment">// 摄氏温度</span>
<span class="token keyword">type</span> Fahrenheit <span class="token builtin">float64</span> <span class="token comment">// 华氏温度</span>

<span class="token comment">// 这两个是不同的数据类型，因此它们不可以被相互比较或混在一个表达式运算</span>

<span class="token comment">// 如 boilingF-FreezingC  将会编译错误</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
    AbsoluteZeroC Celsius <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">273.15</span> <span class="token comment">// 绝对零度</span>
    FreezingC     Celsius <span class="token operator">=</span> <span class="token number">0</span>       <span class="token comment">// 结冰点温度</span>
    BoilingC      Celsius <span class="token operator">=</span> <span class="token number">100</span>     <span class="token comment">// 沸水温度</span>
<span class="token punctuation">)</span>

<span class="token comment">// Fahrenheit() 显式的转换类型</span>
<span class="token keyword">func</span> <span class="token function">CToF</span><span class="token punctuation">(</span>c Celsius<span class="token punctuation">)</span> Fahrenheit <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">Fahrenheit</span><span class="token punctuation">(</span>c<span class="token operator">*</span><span class="token number">9</span><span class="token operator">/</span><span class="token number">5</span> <span class="token operator">+</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">FToC</span><span class="token punctuation">(</span>f Fahrenheit<span class="token punctuation">)</span> Celsius <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">Celsius</span><span class="token punctuation">(</span><span class="token punctuation">(</span>f <span class="token operator">-</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">5</span> <span class="token operator">/</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
</code></pre></div><p>类型转换操作 T(x)，用于将 x 转为 T 类型（两者底层类型相同才能转）</p> <p>类型的方法集</p> <div class="language-go extra-class"><pre class="language-go"><code>
<span class="token comment">// 表示声明的是 Celsius 类型的一个名叫 String 的方法，该方法返回该类型对象 c 带着 °C 温度单位的字符串</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c Celsius<span class="token punctuation">)</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%g°C&quot;</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

ccc <span class="token operator">:=</span> <span class="token function">FToC</span><span class="token punctuation">(</span><span class="token number">212.0</span><span class="token punctuation">)</span> <span class="token comment">// ccc 是 Celsius 类型的变量</span>

fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>ccc<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// &quot;100°C&quot;</span>

</code></pre></div><h3 id="包和文件"><a href="#包和文件" aria-hidden="true" class="header-anchor">#</a> 包和文件</h3> <p>多个文件，可以指定同一个包名，就好像所有代码都在一个文件一样。</p> <p>包级别的名字，例如在一个文件声明的类型和常量，在同一个包的其他源文件也是可以直接访问的</p> <p>包注释，通常只放在一个文件中，如果注释很多，通常是放在一个专用的文件里，如 <code>doc.go</code></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// Package tempconv performs Celsius and Fahrenheit conversions.</span>
<span class="token keyword">package</span> tempconv
</code></pre></div><p>导入包</p> <p>一个包的名字和包的导入路径的最后一个字段相同，例如 gopl.io/ch2/tempconv 包的名字一般是 tempconv</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// Cf converts its numeric argument to Celsius and Fahrenheit.</span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;fmt&quot;</span>
    <span class="token string">&quot;os&quot;</span>
    <span class="token string">&quot;strconv&quot;</span>
    <span class="token string">&quot;gopl.io/ch2/tempconv&quot;</span>
<span class="token punctuation">)</span>

<span class="token comment">// tempconv.CToF</span>

</code></pre></div><p>包的初始化</p> <p>编译器根据依赖顺序进行初始化，也可以将初始化程序放在 init 函数里，或者使用匿名函数自执行</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> popcount

<span class="token keyword">var</span> pc <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token builtin">byte</span>

<span class="token comment">// 一个包可以有多个 init 函数</span>
<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> pc <span class="token punctuation">{</span>
        pc<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> pc<span class="token punctuation">[</span>i<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token function">byte</span><span class="token punctuation">(</span>i<span class="token operator">&amp;</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 或者使用匿名函数自执行进行初始化</span>
<span class="token keyword">var</span> pc <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token builtin">byte</span> <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>pc <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> pc <span class="token punctuation">{</span>
        pc<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> pc<span class="token punctuation">[</span>i<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token function">byte</span><span class="token punctuation">(</span>i<span class="token operator">&amp;</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// PopCount returns the population count (number of set bits) of x.</span>
<span class="token keyword">func</span> <span class="token function">PopCount</span><span class="token punctuation">(</span>x <span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">int</span><span class="token punctuation">(</span>pc<span class="token punctuation">[</span><span class="token function">byte</span><span class="token punctuation">(</span>x<span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span>
        pc<span class="token punctuation">[</span><span class="token function">byte</span><span class="token punctuation">(</span>x<span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span>
        pc<span class="token punctuation">[</span><span class="token function">byte</span><span class="token punctuation">(</span>x<span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span>
        pc<span class="token punctuation">[</span><span class="token function">byte</span><span class="token punctuation">(</span>x<span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="作用域"><a href="#作用域" aria-hidden="true" class="header-anchor">#</a> 作用域</h3> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">var</span> cwd <span class="token builtin">string</span>

<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// var err error</span>
    cwd<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Getwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// NOTE: 如果没有声明过 err 那这里就是一个声明 cwd err 的作用，而全局的 cwd 并不会被赋值</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;os.Getwd failed: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Working directory = %s&quot;</span><span class="token punctuation">,</span> cwd<span class="token punctuation">)</span> <span class="token comment">//</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="基础数据类型"><a href="#基础数据类型" aria-hidden="true" class="header-anchor">#</a> 基础数据类型</h2> <ul><li>基础类型 - 数字 字符串 布尔</li> <li>复合类型 - 数组 结构体</li> <li>引用类型 - 指针 切片 字典 函数 通道</li> <li>接口类型 -</li></ul> <p>整型</p> <p><code>int</code> <code>int32</code> 虽然表示的是同样大小，但仍然是 2 种不同的类型，需要转换。</p> <p><code>-5 % 3</code> 和 <code>-5 % -3</code> 结果都是 -2 , 取决与被取模的符号，<code>%</code> 只用于整型。</p> <p><code>5.0 / 4.0</code> 的结果是 1.25，但是 <code>5 / 4</code> 的结果是 1（去尾）, 取决与运算的类型。</p> <div class="language- extra-class"><pre class="language-text"><code>^      位运算 XOR
&amp;^     位清空（AND NOT）
</code></pre></div><div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">var</span> x <span class="token builtin">uint8</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span> <span class="token operator">|</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span>
<span class="token keyword">var</span> y <span class="token builtin">uint8</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span> <span class="token operator">|</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span>

fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%08b\n&quot;</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span> <span class="token comment">// &quot;00100010&quot;, the set {1, 5}</span>
fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%08b\n&quot;</span><span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token comment">// &quot;00000110&quot;, the set {1, 2}</span>
fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%08b\n&quot;</span><span class="token punctuation">,</span> x<span class="token operator">&amp;^</span>y<span class="token punctuation">)</span> <span class="token comment">// &quot;00100000&quot;, the difference {5}</span>
</code></pre></div><p>浮点型</p> <p>通常应该优先使用 <code>float64</code> 类型，因为 <code>float32</code> 类型的累计计算误差很容易扩散，并且 <code>float32</code> 能精确表示的正整数并不是很大</p> <p>复数</p> <p>复数类型：complex64 complex128 分别对应 float32 float64 ，函数 complex 创建一个复数</p> <div class="language-go extra-class"><pre class="language-go"><code>x <span class="token operator">:=</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token number">2i</span>
<span class="token keyword">var</span> x <span class="token builtin">complex128</span> <span class="token operator">=</span> <span class="token function">complex</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// 1+2i</span>

y <span class="token operator">:=</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">4i</span>

fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>x<span class="token operator">*</span>y<span class="token punctuation">)</span>                 <span class="token comment">// &quot;(-5+10i)&quot;</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">real</span><span class="token punctuation">(</span>x<span class="token operator">*</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span>           <span class="token comment">// &quot;-5&quot; 实部</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">imag</span><span class="token punctuation">(</span>x<span class="token operator">*</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span>           <span class="token comment">// &quot;10&quot; 虚部</span>
</code></pre></div><p>字符串</p> <p>原生的字符串面值形式是 `...`，使用反引号代替双引号</p> <p>UTF8 是一个将 Unicode 码点（rune）编码为字节序列的变长编码</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token string">&quot;unicode/utf8&quot;</span>

s <span class="token operator">:=</span> <span class="token string">&quot;Hello, 世界&quot;</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span>                    <span class="token comment">// &quot;13&quot; 个 Unicode</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>utf8<span class="token punctuation">.</span><span class="token function">RuneCountInString</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// &quot;9&quot; 个 utf8</span>

<span class="token comment">// range 循环会隐身解码</span>
<span class="token keyword">for</span> i<span class="token punctuation">,</span> r <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token string">&quot;Hello, 世界&quot;</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%d\t%q\t%d\n&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> r<span class="token punctuation">,</span> r<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

s <span class="token operator">:=</span> <span class="token string">&quot;プログラム&quot;</span>
r <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">rune</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token comment">// 返回码点序列</span>

fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%x\n&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span>  <span class="token comment">// &quot;[30d7 30ed 30b0 30e9 30e0]&quot;</span>

</code></pre></div><p>字符串和字节 slice 之间可以相互转换：</p> <div class="language-go extra-class"><pre class="language-go"><code>s <span class="token operator">:=</span> <span class="token string">&quot;abc&quot;</span>
b <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
s2 <span class="token operator">:=</span> <span class="token function">string</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
</code></pre></div><p>bytes 包还提供了 Buffer 类型 <code>var buf bytes.Buffer</code></p> <p>字符串的转换 <code>strconv</code> 包</p> <div class="language-Go extra-class"><pre class="language-go"><code>x <span class="token operator">:=</span> <span class="token number">123</span>
y <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%d&quot;</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>y<span class="token punctuation">,</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// &quot;123 123&quot;</span>
</code></pre></div><p>常量</p> <p>常量表达式的值在编译期计算，而不是运行期</p> <p>常量可以是构成类型的一部分</p> <div class="language-Go extra-class"><pre class="language-go"><code><span class="token keyword">const</span> IPv4Len <span class="token operator">=</span> <span class="token number">4</span>

<span class="token keyword">func</span> <span class="token function">parseIPv4</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">)</span> IP <span class="token punctuation">{</span>
	<span class="token keyword">var</span> p <span class="token punctuation">[</span>IPv4Len<span class="token punctuation">]</span><span class="token builtin">byte</span>
<span class="token punctuation">}</span>
</code></pre></div><p>iota 常量生成器</p> <div class="language-Go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> Weekday <span class="token builtin">int</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
	Sunday Weekday <span class="token operator">=</span> <span class="token boolean">iota</span>
	Monday
	Tuesday
	Wednesday
	Thursday
	Friday
	Saturday
<span class="token punctuation">)</span>

<span class="token comment">// iota 会给后面的依次 +1</span>
</code></pre></div><p>无类型常量</p> <p>例如 math.Pi</p> <div class="language-Go extra-class"><pre class="language-go"><code><span class="token keyword">var</span> x <span class="token builtin">float32</span> <span class="token operator">=</span> math<span class="token punctuation">.</span>Pi
<span class="token keyword">var</span> y <span class="token builtin">float64</span> <span class="token operator">=</span> math<span class="token punctuation">.</span>Pi
<span class="token keyword">var</span> z <span class="token builtin">complex128</span> <span class="token operator">=</span> math<span class="token punctuation">.</span>Pi
</code></pre></div><h2 id="复合数据类型"><a href="#复合数据类型" aria-hidden="true" class="header-anchor">#</a> 复合数据类型</h2> <ul><li><p>数组（同构的元素）和结构体（异构的元素）都是有固定内存大小的数据结构</p></li> <li><p>slice 和 map 则是动态的数据结构，它们将根据需要动态增长</p></li></ul> <h3 id="数组"><a href="#数组" aria-hidden="true" class="header-anchor">#</a> 数组</h3> <p>数组 和 slice</p> <p>初始化</p> <div class="language-Go extra-class"><pre class="language-go"><code><span class="token comment">// 长度是数组类型的一部分</span>
<span class="token keyword">var</span> q <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token builtin">int</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span>
q <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span> <span class="token comment">// ... 表示根据初始值的个数来指定数组大小</span>

<span class="token keyword">var</span> r <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token builtin">int</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">}</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>r<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// &quot;0&quot; 未被赋值的元素是零值</span>

<span class="token comment">// 索引和对应值列表的方式</span>
symbol <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>USD<span class="token punctuation">:</span> <span class="token string">&quot;$&quot;</span><span class="token punctuation">,</span> EUR<span class="token punctuation">:</span> <span class="token string">&quot;€&quot;</span><span class="token punctuation">,</span> GBP<span class="token punctuation">:</span> <span class="token string">&quot;￡&quot;</span><span class="token punctuation">,</span> RMB<span class="token punctuation">:</span> <span class="token string">&quot;￥&quot;</span><span class="token punctuation">}</span>

<span class="token comment">// 定义了一个 长度为 100，最后一个元素是 -1 其他都是零值的数组</span>
r <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">99</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">}</span>

<span class="token comment">// 数组的比较</span>

q <span class="token operator">==</span> r <span class="token comment">// 所有元素都相等就是 true</span>
</code></pre></div><p>当数组作为函数参数传进去时，函数接收的是一个副本，而不是引用，除非显式的传入一个指针</p> <p>数组的类型包含了僵化的长度信息，很少使用，更常用的时 slice</p> <h3 id="slice-切片"><a href="#slice-切片" aria-hidden="true" class="header-anchor">#</a> slice 切片</h3> <p>slice 引用了底层数组（注意引用操作，当作参数传入函数后副作用）</p> <p>由三个部分构成：指针、长度、容量，<code>len</code> 和 <code>cap</code> 函数分别返回 slice 的长度和容量</p> <p>slice 的切片操作 s[i:j]，其中 0 ≤ i≤ j≤ cap(s)，用于创建一个新的 slice</p> <p>差异：slice 初始化并没有指定长度、不可比较</p> <p>只能和 nil 比较</p> <div class="language-Go extra-class"><pre class="language-go"><code><span class="token comment">// nil 可以和 slice 相同对待</span>
<span class="token keyword">var</span> s <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>    <span class="token comment">// len(s) == 0, s == nil</span>
s <span class="token operator">=</span> <span class="token boolean">nil</span>        <span class="token comment">// len(s) == 0, s == nil</span>
s <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">int</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span> <span class="token comment">// len(s) == 0, s == nil</span>


s <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token comment">// len(s) == 0, s != nil</span>

<span class="token comment">// 使用 make 函数</span>
<span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>T<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">,</span> <span class="token builtin">cap</span><span class="token punctuation">)</span> <span class="token comment">// same as make([]T, cap)[:len]</span>
</code></pre></div><p>slice 实际上是一个引用了底层数组的聚合类型</p> <div class="language-Go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> IntSlice <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	ptr      <span class="token operator">*</span><span class="token builtin">int</span>
	<span class="token builtin">len</span><span class="token punctuation">,</span> <span class="token builtin">cap</span> <span class="token builtin">int</span>
<span class="token punctuation">}</span>
</code></pre></div><p>append 函数</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// x := []{1, 2, 3}</span>
x <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> x<span class="token operator">...</span><span class="token punctuation">)</span> <span class="token comment">// ... 表示接收变长的参数为 slice （类似解构）</span>
<span class="token comment">// x [1, 2, 3, 1, 2, 3]</span>

stack <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token function">len</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token comment">// pop</span>
</code></pre></div><h3 id="map"><a href="#map" aria-hidden="true" class="header-anchor">#</a> Map</h3> <p>无序的 <code>key/value</code> 对的集合，<code>key</code> 必须是可比较的类型</p> <div class="language-go extra-class"><pre class="language-go"><code>ages <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span>
    <span class="token string">&quot;alice&quot;</span><span class="token punctuation">:</span>   <span class="token number">31</span><span class="token punctuation">,</span>
    <span class="token string">&quot;charlie&quot;</span><span class="token punctuation">:</span> <span class="token number">34</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// 相当于</span>
ages <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span>
ages<span class="token punctuation">[</span><span class="token string">&quot;alice&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">31</span>
ages<span class="token punctuation">[</span><span class="token string">&quot;charlie&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">34</span>

<span class="token comment">// 使用内置的 delete 函数</span>
<span class="token function">delete</span><span class="token punctuation">(</span>ages<span class="token punctuation">,</span> <span class="token string">&quot;alice&quot;</span><span class="token punctuation">)</span>

<span class="token comment">// 不存在的元素返回零值</span>
ages<span class="token punctuation">[</span><span class="token string">&quot;bob&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> ages<span class="token punctuation">[</span><span class="token string">&quot;bob&quot;</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token comment">// 0 + 1</span>

age<span class="token punctuation">,</span> ok <span class="token operator">:=</span> ages<span class="token punctuation">[</span><span class="token string">&quot;bob&quot;</span><span class="token punctuation">]</span> <span class="token comment">// 通过元组的第二位 ok, 判断该元素是否真的存在</span>

<span class="token comment">// map 的元素不是变量，不可取址（因为 map 会重新分配空间，地址会变）</span>
</code></pre></div><div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">for</span> name<span class="token punctuation">,</span> age <span class="token operator">:=</span> <span class="token keyword">range</span> ages <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s\t%d\n&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="结构体"><a href="#结构体" aria-hidden="true" class="header-anchor">#</a> 结构体</h3> <p>由零个或多个任意类型的值聚合成的实体</p> <p>结构体的成员可以取址</p> <p>结构体零值是每个成员都是零值</p> <p>结构体成员也是要首字母大写，才能被外部包访问</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> Employee <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    ID        <span class="token builtin">int</span>
    Name      <span class="token builtin">string</span>
    Address   <span class="token builtin">string</span>
    DoB       time<span class="token punctuation">.</span>Time
    Position  <span class="token builtin">string</span>
    Salary    <span class="token builtin">int</span>
    ManagerID <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> dilbert Employee

<span class="token comment">// 成员类型不能包含自身，但可以包含指针，如</span>
<span class="token keyword">type</span> tree <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    value       <span class="token builtin">int</span>
    left<span class="token punctuation">,</span> right <span class="token operator">*</span>tree
<span class="token punctuation">}</span>
</code></pre></div><p>作为参数/返回值</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> Point <span class="token keyword">struct</span><span class="token punctuation">{</span> X<span class="token punctuation">,</span> Y <span class="token builtin">int</span> <span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Scale</span><span class="token punctuation">(</span>p Point<span class="token punctuation">,</span> factor <span class="token builtin">int</span><span class="token punctuation">)</span> Point <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Point<span class="token punctuation">{</span> p<span class="token punctuation">.</span>X <span class="token operator">*</span> factor<span class="token punctuation">,</span> p<span class="token punctuation">.</span>Y <span class="token operator">*</span> factor <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">Scale</span><span class="token punctuation">(</span>Point<span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// &quot;{5 10}&quot;</span>
</code></pre></div><p>所有的函数参数都是值拷贝传入，如果要修改外部结构体成员，就要传入指针</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// 匿名成员的数据类型必须是命名的类型或指向一个命名的类型的指针</span>

<span class="token keyword">type</span> Circle <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Point
    Radius <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Wheel <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Circle
    Spokes <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> w Wheel

w<span class="token punctuation">.</span>X <span class="token operator">=</span> <span class="token number">8</span>            <span class="token comment">// w.Circle.Point.X = 8</span>

w <span class="token operator">=</span> Wheel<span class="token punctuation">{</span>
    Circle<span class="token punctuation">:</span> Circle<span class="token punctuation">{</span>
        Point<span class="token punctuation">:</span>  Point<span class="token punctuation">{</span>X<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span> Y<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        Radius<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    Spokes<span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token comment">// , 号结尾</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="json"><a href="#json" aria-hidden="true" class="header-anchor">#</a> JSON</h3> <p>将结构体 slice 转为 JSON 的过程叫编组（marshaling）</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> Movie <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Title  <span class="token builtin">string</span>
    Year   <span class="token builtin">int</span>  <span class="token string">`json:&quot;released&quot;`</span>
    Color  <span class="token builtin">bool</span> <span class="token string">`json:&quot;color,omitempty&quot;`</span>
    Actors <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> movies <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Movie<span class="token punctuation">{</span>
    <span class="token punctuation">{</span>Title<span class="token punctuation">:</span> <span class="token string">&quot;Casablanca&quot;</span><span class="token punctuation">,</span> Year<span class="token punctuation">:</span> <span class="token number">1942</span><span class="token punctuation">,</span> Color<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        Actors<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;Humphrey Bogart&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Ingrid Bergman&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>Title<span class="token punctuation">:</span> <span class="token string">&quot;Cool Hand Luke&quot;</span><span class="token punctuation">,</span> Year<span class="token punctuation">:</span> <span class="token number">1967</span><span class="token punctuation">,</span> Color<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        Actors<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;Paul Newman&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>Title<span class="token punctuation">:</span> <span class="token string">&quot;Bullitt&quot;</span><span class="token punctuation">,</span> Year<span class="token punctuation">:</span> <span class="token number">1968</span><span class="token punctuation">,</span> Color<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        Actors<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;Steve McQueen&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Jacqueline Bisset&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

data<span class="token punctuation">,</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>movies<span class="token punctuation">)</span> <span class="token comment">// 用 MarshalIndent 可以将返回字符串缩进</span>

<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;JSON marshaling failed: %s&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s\n&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
</code></pre></div><div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">var</span> titles <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">{</span> Title <span class="token builtin">string</span> <span class="token punctuation">}</span>

<span class="token comment">// 指定结构体类型 解码 JSON 字符串</span>
<span class="token keyword">if</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>titles<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;JSON unmarshaling failed: %s&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>titles<span class="token punctuation">)</span> <span class="token comment">// &quot;[{Casablanca} {Cool Hand Luke} {Bullitt}]&quot;</span>
</code></pre></div><h3 id="文本和-html-模板"><a href="#文本和-html-模板" aria-hidden="true" class="header-anchor">#</a> 文本和 HTML 模板</h3> <p>&quot;text/template&quot;</p> <p>&quot;html/template&quot;</p> <p>html 用于处理 html 模板</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> templ <span class="token operator">=</span> <span class="token string">`&lt;p&gt;A: {{.A}}&lt;/p&gt;&lt;p&gt;B: {{.B}}&lt;/p&gt;`</span>
	t <span class="token operator">:=</span> template<span class="token punctuation">.</span><span class="token function">Must</span><span class="token punctuation">(</span>template<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;escape&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>templ<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">var</span> data <span class="token keyword">struct</span> <span class="token punctuation">{</span>
			A <span class="token builtin">string</span>        <span class="token comment">// html 字符会被转义</span>
			B template<span class="token punctuation">.</span>HTML
	<span class="token punctuation">}</span>
	data<span class="token punctuation">.</span>A <span class="token operator">=</span> <span class="token string">&quot;&lt;b&gt;Hello!&lt;/b&gt;&quot;</span>
	data<span class="token punctuation">.</span>B <span class="token operator">=</span> <span class="token string">&quot;&lt;b&gt;Hello!&lt;/b&gt;&quot;</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stdout<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// &lt;p&gt;A: &amp;lt;b&amp;gt;Hello!&amp;lt;/b&amp;gt;&lt;/p&gt;&lt;p&gt;B: &lt;b&gt;Hello!&lt;/b&gt;&lt;/p&gt;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="函数"><a href="#函数" aria-hidden="true" class="header-anchor">#</a> 函数</h2> <h3 id="函数声明"><a href="#函数声明" aria-hidden="true" class="header-anchor">#</a> 函数声明</h3> <blockquote><p>当返回是一个无名变量或没有返回时，返回值列表的括号可以省略</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>func name(parameter-list) (result-list) {
    body
}
</code></pre></div><p>函数的形参是实参的拷贝，如果实参包括引用类型，如指针，slice(切片)、map、function、channel 等类型，实参可能会由于函数的间接引用被修改</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> math

<span class="token keyword">func</span> <span class="token function">Sin</span><span class="token punctuation">(</span>x <span class="token builtin">float64</span><span class="token punctuation">)</span> float <span class="token comment">// 没有函数体的声明，表示该函数不是以 Go 实现的</span>
</code></pre></div><h3 id="递归"><a href="#递归" aria-hidden="true" class="header-anchor">#</a> 递归</h3> <p>Go 语言使用可变栈，栈的大小按需增加(初始时很小)。这使得我们使用递归时不必考虑溢出和安全问题</p> <h3 id="多返回值"><a href="#多返回值" aria-hidden="true" class="header-anchor">#</a> 多返回值</h3> <p>期望值, error</p> <p><code>bare return</code> 减少重复代码，但不利于阅读</p> <p>如果一个函数将所有的返回值都显示的变量名，那么该函数的 return 语句可以省略操作数。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">CountWordsAndImages</span><span class="token punctuation">(</span>url <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>words<span class="token punctuation">,</span> images <span class="token builtin">int</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    doc<span class="token punctuation">,</span> err <span class="token operator">:=</span> html<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>
    resp<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        err <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;parsing HTML: %s&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    words<span class="token punctuation">,</span> images <span class="token operator">=</span> <span class="token function">countWordsAndImages</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span>
    <span class="token keyword">return</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">countWordsAndImages</span><span class="token punctuation">(</span>n <span class="token operator">*</span>html<span class="token punctuation">.</span>Node<span class="token punctuation">)</span> <span class="token punctuation">(</span>words<span class="token punctuation">,</span> images <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* ... */</span> <span class="token punctuation">}</span>

<span class="token comment">// 函数体内的每个 return 都相当于 return words, images, err</span>
</code></pre></div><h3 id="错误"><a href="#错误" aria-hidden="true" class="header-anchor">#</a> 错误</h3> <p>error 类型可能是 nil 或者 non-nil。nil 意味着函数运行成功，non-nil 表示失败</p> <p>格式化错误信息</p> <div class="language-go extra-class"><pre class="language-go"><code>doc<span class="token punctuation">,</span> err <span class="token operator">:=</span> html<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>

resp<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;parsing %s as HTML: %v&quot;</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>错误重试</p> <p>输出错误信息并结束程序 只应在 main 函数中使用</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">WaitForServer</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span> <span class="token string">&quot;Site is down: %v\n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用 log.Fatalf 达到上面的效果</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// log 中的所有函数，都默认会在错误信息之前输出时间信息</span>
<span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">WaitForServer</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;Site is down: %v\n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span> <span class="token comment">// 也能退出程序</span>
    log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;ping failed: %v; networking disabled&quot;</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span> <span class="token comment">// 只输出</span>
    fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span> <span class="token string">&quot;ping failed: %v; networking disabled\n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span> <span class="token comment">// 标准错误输出</span>
<span class="token punctuation">}</span>
</code></pre></div><p>文件结尾错误（EOF）</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> io

<span class="token keyword">import</span> <span class="token string">&quot;errors&quot;</span>

<span class="token keyword">var</span> EOF <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;EOF&quot;</span><span class="token punctuation">)</span> <span class="token comment">//  EOF 错误常量</span>

</code></pre></div><h3 id="函数值"><a href="#函数值" aria-hidden="true" class="header-anchor">#</a> 函数值</h3> <p>函数和其他值一样拥有类型（也是一等公民）</p> <p>函数之间不可比较，不可作为 map 的 key</p> <h3 id="匿名函数"><a href="#匿名函数" aria-hidden="true" class="header-anchor">#</a> 匿名函数</h3> <p>函数闭包</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">squares</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> x <span class="token builtin">int</span>
    <span class="token comment">// squares()</span>
	<span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
		x<span class="token operator">++</span>
		<span class="token keyword">return</span> x <span class="token operator">*</span> x
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>匿名函数的递归调用</p> <div class="language-Go extra-class"><pre class="language-go"><code><span class="token comment">// var visitAll func(items []string)</span>
visitAll <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>items <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">visitAll</span><span class="token punctuation">(</span>m<span class="token punctuation">[</span>item<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 如果没有先声明，编译会报错 undefined: visitAll</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="可变参数"><a href="#可变参数" aria-hidden="true" class="header-anchor">#</a> 可变参数</h3> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// `...int` 表示接收任意个数的 `int` 类型的参数</span>
<span class="token keyword">func</span> <span class="token function">sum</span><span class="token punctuation">(</span>vals <span class="token operator">...</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
    total <span class="token operator">:=</span> <span class="token number">0</span>
    <span class="token comment">// vals 被当作 []int 切片</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> val <span class="token operator">:=</span> <span class="token keyword">range</span> vals <span class="token punctuation">{</span>
        total <span class="token operator">+=</span> val
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> total
<span class="token punctuation">}</span>
</code></pre></div><h3 id="deferred-函数"><a href="#deferred-函数" aria-hidden="true" class="header-anchor">#</a> Deferred 函数</h3> <p>defer 在函数 A 内用 defer 关键字调用的函数 B 会在在函数 A return 后执行</p> <p>defer 语句经常被用于处理成对的操作，如打开/关闭、连接/断开连接、加锁/释放锁</p> <p>可以修改返回值</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">triple</span><span class="token punctuation">(</span>x <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>result <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> result <span class="token operator">+=</span> x <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// defer 后的语句会在 函数 return 之后执行</span>
    <span class="token keyword">return</span> <span class="token function">double</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">triple</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 12</span>
</code></pre></div><h3 id="panic-异常"><a href="#panic-异常" aria-hidden="true" class="header-anchor">#</a> Panic 异常</h3> <p>一般运行时错误会引起 painc 异常，程序中断运行，并立即执行在该 goroutine 中被延迟的函数（defer），随后程序崩溃并输出日志信息</p> <p>输出堆栈信息</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">defer</span> <span class="token function">printStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 如果发生 painc 异常</span>
<span class="token keyword">func</span> <span class="token function">printStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> buf <span class="token punctuation">[</span><span class="token number">4096</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
    n <span class="token operator">:=</span> runtime<span class="token punctuation">.</span><span class="token function">Stack</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token comment">// runtime.Stack 获取异常信息</span>
    os<span class="token punctuation">.</span>Stdout<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// panic 函数主动抛出异常</span>
<span class="token function">panic</span><span class="token punctuation">(</span>err_info<span class="token punctuation">)</span>
</code></pre></div><h3 id="recover-捕获异常"><a href="#recover-捕获异常" aria-hidden="true" class="header-anchor">#</a> Recover 捕获异常</h3> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Parse</span><span class="token punctuation">(</span>input <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Syntax<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 使用内置的 recover 函数，使程序从 panic 异常中恢复</span>
        <span class="token keyword">if</span> p <span class="token operator">:=</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> p <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            err <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;internal error: %v&quot;</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token comment">// 可以把错误信息放到返回值 err 里</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="方法"><a href="#方法" aria-hidden="true" class="header-anchor">#</a> 方法</h2> <p>可以给同一个包内的任意命名类型定义方法，只要这个命名类型的<code>底层类型</code>不是指针或者 interface</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> P <span class="token operator">*</span><span class="token builtin">int</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>P<span class="token punctuation">)</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// 编译错误: invalid receiver type</span>

<span class="token keyword">type</span> P <span class="token builtin">int</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>P<span class="token punctuation">)</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// 这样是可以的，基于指针的对象方法</span>
</code></pre></div><h3 id="方法声明"><a href="#方法声明" aria-hidden="true" class="header-anchor">#</a> 方法声明</h3> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> geometry

<span class="token keyword">import</span> <span class="token string">&quot;math&quot;</span>

<span class="token keyword">type</span> Point <span class="token keyword">struct</span><span class="token punctuation">{</span> X<span class="token punctuation">,</span> Y <span class="token builtin">float64</span> <span class="token punctuation">}</span>

<span class="token comment">// 附加参数 p 叫做方法 Distance 的接收器，p 就取命名类型 Point 首字母即可</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>p Point<span class="token punctuation">)</span> <span class="token function">Distance</span><span class="token punctuation">(</span>q Point<span class="token punctuation">)</span> <span class="token builtin">float64</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> math<span class="token punctuation">.</span><span class="token function">Hypot</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>X <span class="token operator">-</span> p<span class="token punctuation">.</span>X<span class="token punctuation">,</span> q<span class="token punctuation">.</span>Y <span class="token operator">-</span> p<span class="token punctuation">.</span>Y<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 之后 Point 类型的变量都具有 Distance 方法</span>
p <span class="token operator">:=</span> Point<span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">}</span>
q <span class="token operator">:=</span> Point<span class="token punctuation">{</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">}</span>

fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">Distance</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> q<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 包的调用 geometry.Distance</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">Distance</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// 方法调用 Point.Distance</span>
</code></pre></div><h3 id="基于指针的对象方法"><a href="#基于指针的对象方法" aria-hidden="true" class="header-anchor">#</a> 基于指针的对象方法</h3> <p>这样可以在函数里使用引用，而不是副本</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// (*Point).ScaleBy</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Point<span class="token punctuation">)</span> <span class="token function">ScaleBy</span><span class="token punctuation">(</span>factor <span class="token builtin">float64</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	p<span class="token punctuation">.</span>X <span class="token operator">*=</span> factor
	p<span class="token punctuation">.</span>Y <span class="token operator">*=</span> factor
<span class="token punctuation">}</span>

r <span class="token operator">:=</span> <span class="token operator">&amp;</span>Point<span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">}</span> <span class="token comment">// 寻址</span>
r <span class="token operator">:=</span> Point<span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">}</span> <span class="token comment">// 如果方法需要一个指针作为接收器，编译器会隐式 &amp;r 去调用</span>
r<span class="token punctuation">.</span><span class="token function">ScaleBy</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>

fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">*</span>r<span class="token punctuation">)</span> <span class="token comment">// 取值</span>
</code></pre></div><p>解引用符号 <code>*</code></p> <h3 id="通过嵌入结构体来扩展类型"><a href="#通过嵌入结构体来扩展类型" aria-hidden="true" class="header-anchor">#</a> 通过嵌入结构体来扩展类型</h3> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token string">&quot;image/color&quot;</span>

<span class="token keyword">type</span> Point <span class="token keyword">struct</span><span class="token punctuation">{</span> X<span class="token punctuation">,</span> Y <span class="token builtin">float64</span> <span class="token punctuation">}</span>

<span class="token keyword">type</span> ColoredPoint <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Point
	Color color<span class="token punctuation">.</span>RGBA
<span class="token punctuation">}</span>

<span class="token keyword">var</span> cp ColoredPoint、

cp<span class="token punctuation">.</span>X <span class="token operator">=</span> <span class="token number">1</span> <span class="token comment">// cp.Point.X</span>
cp<span class="token punctuation">.</span>Point<span class="token punctuation">.</span>Y <span class="token operator">=</span> <span class="token number">2</span> <span class="token comment">// cp.Y</span>

<span class="token comment">// 我们可以把 ColoredPoint 类型当作接收器来调用 Point 里的方法，即使 ColoredPoint 里没有声明这些方法</span>

cp<span class="token punctuation">.</span><span class="token function">Distance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 调用 Point 里的方法，因为他 has a Point</span>
</code></pre></div><p>当调用一个方法时，编译器会在结构体里一层一层递归找下去，如果同一级里存在同名的方法就会报错</p> <h3 id="方法值-和-方法表达式"><a href="#方法值-和-方法表达式" aria-hidden="true" class="header-anchor">#</a> 方法值 和 方法表达式</h3> <p>p.Distance() 其中 p.Distance 叫做选择器，选择器返回一个方法的值</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> Rocket <span class="token keyword">struct</span> <span class="token punctuation">{</span> <span class="token comment">/* ... */</span> <span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Rocket<span class="token punctuation">)</span> <span class="token function">Launch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* ... */</span> <span class="token punctuation">}</span>
r <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>Rocket<span class="token punctuation">)</span>
time<span class="token punctuation">.</span><span class="token function">AfterFunc</span><span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> r<span class="token punctuation">.</span><span class="token function">Launch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// r.Launch 作为一个方法的值传入即可</span>
time<span class="token punctuation">.</span><span class="token function">AfterFunc</span><span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> r<span class="token punctuation">.</span>Launch<span class="token punctuation">)</span>
</code></pre></div><p>方法表达式</p> <p>当 T 是一个类型时，方法表达式可能会写作 <code>T.f</code> 或者 <code>(*T).f</code>，会返回一个<code>函数</code>，这种函数会将其第一个参数用作接收器</p> <div class="language-go extra-class"><pre class="language-go"><code>p <span class="token operator">:=</span> Point<span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">}</span>
q <span class="token operator">:=</span> Point<span class="token punctuation">{</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">}</span>

distance <span class="token operator">:=</span> Point<span class="token punctuation">.</span>Distance
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">distance</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> q<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// p 作为接收器</span>
fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%T\n&quot;</span><span class="token punctuation">,</span> distance<span class="token punctuation">)</span> <span class="token comment">// &quot;func(Point, Point) float64&quot;</span>
</code></pre></div><h3 id="bit-数组"><a href="#bit-数组" aria-hidden="true" class="header-anchor">#</a> Bit 数组</h3> <p>？？？</p> <h3 id="封装"><a href="#封装" aria-hidden="true" class="header-anchor">#</a> 封装</h3> <p>如果我们要封装一个对象，必须将其定义成一个 struct 同样的根据成员的首字母大小写还表示对外是否可见</p> <h2 id="接口"><a href="#接口" aria-hidden="true" class="header-anchor">#</a> 接口</h2> <p>接口类型是对其它类型行为的抽象和概括，满足隐式实现的</p> <p>接口只有当有两个或两个以上的具体类型必须以相同的方式进行处理时才需要</p> <h3 id="接口约定"><a href="#接口约定" aria-hidden="true" class="header-anchor">#</a> 接口约定</h3> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> io
<span class="token comment">// 当某个函数参数要求是 Writer 类型时，那么传入的变量必须有 Write 这个方法</span>
<span class="token keyword">type</span> Writer <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Write</span><span class="token punctuation">(</span>p <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="接口类型"><a href="#接口类型" aria-hidden="true" class="header-anchor">#</a> 接口类型</h3> <p>接口类型<code>具体描述了</code>一系列方法的集合，一个实现了这些方法的<code>具体类型</code>是这个<code>接口类型的实例</code>。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> io
<span class="token keyword">type</span> Reader <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Read</span><span class="token punctuation">(</span>p <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">type</span> Closer <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token punctuation">}</span>

<span class="token comment">// 内嵌</span>
<span class="token keyword">type</span> ReadWriteCloser <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	Reader
	Closer
<span class="token punctuation">}</span>
</code></pre></div><h3 id="实现接口的条件"><a href="#实现接口的条件" aria-hidden="true" class="header-anchor">#</a> 实现接口的条件</h3> <p>一个类型如果拥有一个接口需要的所有方法，那么这个类型就实现了这个接口</p> <p>在 T 类型的参数上调用一个<code>*T</code>的方法是合法的，但这仅仅是一个语法糖。如果 T 实现了一个接口，但 <code>*T</code> 没有实现</p> <p>空接口类型，可以是任意类型，但不能对他持有的值做操作，因为它没有任何方法</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">var</span> any <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
any <span class="token operator">=</span> <span class="token boolean">true</span>
any <span class="token operator">=</span> <span class="token number">12.34</span>
any <span class="token operator">=</span> <span class="token string">&quot;hello&quot;</span>
any <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token string">&quot;one&quot;</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span>
any <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span>Buffer<span class="token punctuation">)</span>
</code></pre></div><h3 id="标准的接口类型-flag-value"><a href="#标准的接口类型-flag-value" aria-hidden="true" class="header-anchor">#</a> 标准的接口类型 flag.Value</h3> <p>？？？</p> <h3 id="接口值"><a href="#接口值" aria-hidden="true" class="header-anchor">#</a> 接口值</h3> <p>具体的类型 + 那个类型的值</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">var</span> w io<span class="token punctuation">.</span>Writer <span class="token comment">// nil 接口值</span>
w <span class="token operator">=</span> os<span class="token punctuation">.</span>Stdout   <span class="token comment">// 具体类型到接口类型的隐式转换</span>
w <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span>Buffer<span class="token punctuation">)</span>
w <span class="token operator">=</span> <span class="token boolean">nil</span>
</code></pre></div><p>一个不包含任何值的 <code>nil 接口值</code>和一个刚好包含 <code>nil 指针的接口值</code>是不同的</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">var</span> buf <span class="token operator">*</span>bytes<span class="token punctuation">.</span>Buffer <span class="token comment">// nil 指针的接口值</span>
<span class="token comment">// 此时</span>
buf <span class="token operator">!=</span> <span class="token boolean">nil</span>
</code></pre></div><h3 id="sort-interface-接口"><a href="#sort-interface-接口" aria-hidden="true" class="header-anchor">#</a> sort.Interface 接口</h3> <p>sort.Sort 使用了一个接口类型 sort.Interface 来指定通用的排序算法和可能被排序到的序列类型之间的约定</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> sort

<span class="token keyword">type</span> Interface <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token comment">// 长度</span>
	<span class="token function">Less</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token comment">// 比较结果</span>
	<span class="token function">Swap</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token comment">// 交换</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="http-handler-接口"><a href="#http-handler-接口" aria-hidden="true" class="header-anchor">#</a> http.Handler 接口</h3> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> database <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>dollars

<span class="token keyword">func</span> <span class="token punctuation">(</span>db database<span class="token punctuation">)</span> <span class="token function">list</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> item<span class="token punctuation">,</span> price <span class="token operator">:=</span> <span class="token keyword">range</span> db <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">&quot;%s: %s\n&quot;</span><span class="token punctuation">,</span> item<span class="token punctuation">,</span> price<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	db <span class="token operator">:=</span> database<span class="token punctuation">{</span><span class="token string">&quot;shoes&quot;</span><span class="token punctuation">:</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token string">&quot;socks&quot;</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">}</span>
	http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">&quot;/list&quot;</span><span class="token punctuation">,</span> db<span class="token punctuation">.</span>list<span class="token punctuation">)</span>
	http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">&quot;/price&quot;</span><span class="token punctuation">,</span> db<span class="token punctuation">.</span>price<span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token string">&quot;localhost:8000&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="error-接口"><a href="#error-接口" aria-hidden="true" class="header-anchor">#</a> error 接口</h3> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> <span class="token builtin">error</span> <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="表达式求值"><a href="#表达式求值" aria-hidden="true" class="header-anchor">#</a> 表达式求值</h3> <p>？？？</p> <h3 id="类型断言"><a href="#类型断言" aria-hidden="true" class="header-anchor">#</a> 类型断言</h3> <p><code>x.(T)</code> 一个类型断言检查它操作对象的动态类型是否和断言的类型匹配，如果检查成功了，类型断言的结果是 x 的动态值</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">var</span> w io<span class="token punctuation">.</span>Writer
w <span class="token operator">=</span> os<span class="token punctuation">.</span>Stdout <span class="token comment">// w 是一个动态类型</span>
f<span class="token punctuation">,</span> ok <span class="token operator">:=</span> w<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>os<span class="token punctuation">.</span>File<span class="token punctuation">)</span>      <span class="token comment">// success: f == os.Stdout</span>
c<span class="token punctuation">,</span> ok <span class="token operator">:=</span> w<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>bytes<span class="token punctuation">.</span>Buffer<span class="token punctuation">)</span> <span class="token comment">// panic: interface holds *os.File, not *bytes.Buffer</span>
</code></pre></div><h3 id="基于类型断言区别错误类型"><a href="#基于类型断言区别错误类型" aria-hidden="true" class="header-anchor">#</a> 基于类型断言区别错误类型</h3> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> os

<span class="token keyword">func</span> <span class="token function">IsExist</span><span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
<span class="token keyword">func</span> <span class="token function">IsNotExist</span><span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
<span class="token keyword">func</span> <span class="token function">IsPermission</span><span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
</code></pre></div><h3 id="通过类型断言询问行为"><a href="#通过类型断言询问行为" aria-hidden="true" class="header-anchor">#</a> 通过类型断言询问行为</h3> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">writeString</span><span class="token punctuation">(</span>w io<span class="token punctuation">.</span>Writer<span class="token punctuation">,</span> s <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">type</span> stringWriter <span class="token keyword">interface</span> <span class="token punctuation">{</span>
		<span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 断言 w 类型</span>
	<span class="token keyword">if</span> sw<span class="token punctuation">,</span> ok <span class="token operator">:=</span> w<span class="token punctuation">.</span><span class="token punctuation">(</span>stringWriter<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		<span class="token keyword">return</span> sw<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token comment">// avoid a copy</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// allocate temporary copy</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="类型分支"><a href="#类型分支" aria-hidden="true" class="header-anchor">#</a> 类型分支</h3> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">sqlQuote</span><span class="token punctuation">(</span>x <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">switch</span> x <span class="token operator">:=</span> x<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> <span class="token boolean">nil</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token string">&quot;NULL&quot;</span>
	<span class="token keyword">case</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">uint</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%d&quot;</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span> <span class="token comment">// x has type interface{} here.</span>
	<span class="token keyword">case</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
		<span class="token keyword">if</span> x <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token string">&quot;TRUE&quot;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token string">&quot;FALSE&quot;</span>
	<span class="token keyword">case</span> <span class="token builtin">string</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token function">sqlQuoteString</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token comment">// (not shown)</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;unexpected type %T: %v&quot;</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用了关键词 <code>type</code> 通过 case 匹配 x 的类型，并新创建一个变量 x 只作用于 switch 此法块</p> <p>虽然 x 的类型是 interface{}，但是我们把它认为是一个 int，uint，bool，string，和 nil 值的 discriminated union（可识别联合）</p> <h3 id="基于标记的-xml-解码"><a href="#基于标记的-xml-解码" aria-hidden="true" class="header-anchor">#</a> 基于标记的 XML 解码</h3> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;encoding/xml&quot;</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;io&quot;</span>
	<span class="token string">&quot;os&quot;</span>
	<span class="token string">&quot;strings&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	dec <span class="token operator">:=</span> xml<span class="token punctuation">.</span><span class="token function">NewDecoder</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stdin<span class="token punctuation">)</span>
	<span class="token keyword">var</span> stack <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token comment">// stack of element names</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		tok<span class="token punctuation">,</span> err <span class="token operator">:=</span> dec<span class="token punctuation">.</span><span class="token function">Token</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">==</span> io<span class="token punctuation">.</span>EOF <span class="token punctuation">{</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span> <span class="token string">&quot;xmlselect: %v\n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">switch</span> tok <span class="token operator">:=</span> tok<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> xml<span class="token punctuation">.</span>StartElement<span class="token punctuation">:</span>
			stack <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>stack<span class="token punctuation">,</span> tok<span class="token punctuation">.</span>Name<span class="token punctuation">.</span>Local<span class="token punctuation">)</span> <span class="token comment">// push</span>
		<span class="token keyword">case</span> xml<span class="token punctuation">.</span>EndElement<span class="token punctuation">:</span>
			stack <span class="token operator">=</span> stack<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token function">len</span><span class="token punctuation">(</span>stack<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token comment">// pop</span>
		<span class="token keyword">case</span> xml<span class="token punctuation">.</span>CharData<span class="token punctuation">:</span>
			<span class="token keyword">if</span> <span class="token function">containsAll</span><span class="token punctuation">(</span>stack<span class="token punctuation">,</span> os<span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s: %s\n&quot;</span><span class="token punctuation">,</span> strings<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>stack<span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tok<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// x 是否包含 y</span>
<span class="token keyword">func</span> <span class="token function">containsAll</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token function">len</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token function">len</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">true</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> y<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
			y <span class="token operator">=</span> y<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
		<span class="token punctuation">}</span>
		x <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="goroutines-和-channels"><a href="#goroutines-和-channels" aria-hidden="true" class="header-anchor">#</a> Goroutines 和 Channels</h2> <p>两种并发手段：</p> <p>goroutine 和 channel，支持 CSP（communicating sequential processes）顺序通信进程，值会在不同的运行实例（goroutine）中传递</p> <p>传统并发：多线程共享内存</p> <h3 id="goroutines"><a href="#goroutines" aria-hidden="true" class="header-anchor">#</a> Goroutines</h3> <p>当一个程序启动时，其主函数即在一个单独的 goroutine 中运行，我们叫它 main goroutine。新的 goroutine 会用 go 语句来创建</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">go</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// go 创建一个协程</span>
</code></pre></div><p>主函数返回时，所有的 goroutine 都会被直接打断，程序退出</p> <h3 id="channels"><a href="#channels" aria-hidden="true" class="header-anchor">#</a> Channels</h3> <p>goroutine 之间发送值信息的通信机制</p> <p>和 map 类似，channel 也对应一个 make 创建的底层数据结构的引用，复制或函数传参，只是拷贝了一个 channel 引用</p> <div class="language-Go extra-class"><pre class="language-go"><code><span class="token comment">// 一个可以发送 int 类型数据的 channel 一般写为 chan int</span>
ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token comment">// 不带缓存</span>

ch <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">// 带缓存，内部持有一个队列，队列容量是 3 个值</span>

ch <span class="token operator">&lt;-</span> x  <span class="token comment">// x 是要发送的值</span>
x <span class="token operator">=</span> <span class="token operator">&lt;-</span>ch <span class="token comment">// x 接收值</span>
<span class="token operator">&lt;-</span>ch     <span class="token comment">// 不使用接收结果的接收操作</span>

<span class="token function">close</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span> <span class="token comment">// 关闭</span>
</code></pre></div><p>不带缓存的 Channels 也被称为 同步 Channels</p> <p>发送操作将导致 goroutine 阻塞，直到执行了接收操作，成功传输之后才可以执行后面的语句
反之，接收操作先发生也会阻塞，直到执行了发送操作</p> <p>x, y 事件并发，并不意味着同时发生，而是不能确定这两件事发生的先后顺序</p> <div class="language-Go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Dial</span><span class="token punctuation">(</span><span class="token string">&quot;tcp&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;localhost:8000&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// channel</span>
    done <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 开一个 goroutine</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        io<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stdout<span class="token punctuation">,</span> conn<span class="token punctuation">)</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;done&quot;</span><span class="token punctuation">)</span>
		done <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// 给 channel 发消息（通知 main goroutine）</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">mustCopy</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> os<span class="token punctuation">.</span>Stdin<span class="token punctuation">)</span>
	conn<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token operator">&lt;-</span>done <span class="token comment">// 等待接收 channel 的消息（也就是等待后台 goroutine 结束）</span>
<span class="token punctuation">}</span>
</code></pre></div><p>串联的 Channels（Pipeline）</p> <div class="language-Go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	naturals <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
	squares <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>

	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> x <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> x<span class="token operator">++</span> <span class="token punctuation">{</span>
			naturals <span class="token operator">&lt;-</span> x
		<span class="token punctuation">}</span>
		<span class="token function">close</span><span class="token punctuation">(</span>naturals<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> x <span class="token operator">:=</span> <span class="token keyword">range</span> naturals <span class="token punctuation">{</span>
			squares <span class="token operator">&lt;-</span> x <span class="token operator">*</span> x
		<span class="token punctuation">}</span>
		<span class="token function">close</span><span class="token punctuation">(</span>squares<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> x <span class="token operator">:=</span> <span class="token keyword">range</span> squares <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用 range 循环依次从 channel 接收数据，当 channel 被关闭并且没有值可接收时跳出循环</p> <p>当 channel 没有被引用时将会被回收器回收</p> <p>单方向的 Channel</p> <p>提供了单方向的 channel 类型，分别用于只发送或只接收的 channel</p> <p><code>chan &lt;- int</code> 表示只接收 <code>&lt;- chan int</code> 表示只发送</p> <div class="language-Go extra-class"><pre class="language-go"><code><span class="token comment">// 只发送</span>
<span class="token keyword">func</span> <span class="token function">counter</span><span class="token punctuation">(</span>out <span class="token keyword">chan</span><span class="token operator">&lt;-</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> x <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> x<span class="token operator">++</span> <span class="token punctuation">{</span>
		out <span class="token operator">&lt;-</span> x
	<span class="token punctuation">}</span>
	<span class="token function">close</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">squarer</span><span class="token punctuation">(</span>out <span class="token keyword">chan</span><span class="token operator">&lt;-</span> <span class="token builtin">int</span><span class="token punctuation">,</span> in <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> in <span class="token punctuation">{</span>
		out <span class="token operator">&lt;-</span> v <span class="token operator">*</span> v
	<span class="token punctuation">}</span>
	<span class="token function">close</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 只接收</span>
<span class="token keyword">func</span> <span class="token function">printer</span><span class="token punctuation">(</span>in <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> in <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	naturals <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
  squares <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
  <span class="token comment">// 双向 channel 传给接收 单向 channel 时，发生隐式转换</span>
	<span class="token keyword">go</span> <span class="token function">counter</span><span class="token punctuation">(</span>naturals<span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">squarer</span><span class="token punctuation">(</span>squares<span class="token punctuation">,</span> naturals<span class="token punctuation">)</span>
	<span class="token function">printer</span><span class="token punctuation">(</span>squares<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>带缓存的 Channels</p> <div class="language-Go extra-class"><pre class="language-go"><code>ch <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>

fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 缓存元素个数</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">cap</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 缓存元素容量</span>
</code></pre></div><p>向缓存 Channel 的发送操作就是向内部缓存队列的尾部插入元素，接收操作则是从队列的头部删除元素。
如果内部缓存队列是满的，那么发送操作将阻塞直到因另一个 goroutine 执行接收操作而释放了新的队列空间。
相反，如果 channel 是空的，接收操作将阻塞直到有另一个 goroutine 执行发送操作而向队列插入元素</p> <p>就像一个生产线上的多个工位，最高效的方式是平衡各个工位的效率，而加缓存队列并不能提高整体效率。</p> <h3 id="并发的循环"><a href="#并发的循环" aria-hidden="true" class="header-anchor">#</a> 并发的循环</h3> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">makeThumbnails6</span><span class="token punctuation">(</span>filenames <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">int64</span> <span class="token punctuation">{</span>
	sizes <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int64</span><span class="token punctuation">)</span>
	<span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup <span class="token comment">// 开启的 goroutines 计数，开启一个就 +1，结束一个就 -1</span>
	<span class="token keyword">for</span> f <span class="token operator">:=</span> <span class="token keyword">range</span> filenames <span class="token punctuation">{</span>
		wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>f <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// == wg.Add(-1)</span>
			thumb<span class="token punctuation">,</span> err <span class="token operator">:=</span> thumbnail<span class="token punctuation">.</span><span class="token function">ImageFile</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token comment">// f 闭包传入</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>
            info<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Stat</span><span class="token punctuation">(</span>thumb<span class="token punctuation">)</span>
			sizes <span class="token operator">&lt;-</span> info<span class="token punctuation">.</span><span class="token function">Size</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 都结束后，关闭 channel</span>
		<span class="token function">close</span><span class="token punctuation">(</span>sizes<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">var</span> total <span class="token builtin">int64</span>
	<span class="token keyword">for</span> size <span class="token operator">:=</span> <span class="token keyword">range</span> sizes <span class="token punctuation">{</span>
		total <span class="token operator">+=</span> size
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> total
<span class="token punctuation">}</span>
</code></pre></div><h3 id="并发的-web-爬虫"><a href="#并发的-web-爬虫" aria-hidden="true" class="header-anchor">#</a> 并发的 Web 爬虫</h3> <p>？？？</p> <h3 id="基于-select-的多路复用"><a href="#基于-select-的多路复用" aria-hidden="true" class="header-anchor">#</a> 基于 select 的多路复用</h3> <p>每个 case 代表一个通信操作（接收 or 发送），select 会等待有能够执行的 case 时去执行。
如果有多个 case 准备就绪，select 会随机选择一个去执行，select 有一种轮询的效果</p> <div class="language-go extra-class"><pre class="language-go"><code>ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
	<span class="token keyword">select</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> x <span class="token operator">:=</span> <span class="token operator">&lt;-</span>ch<span class="token punctuation">:</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>  <span class="token comment">// &quot;0&quot; &quot;2&quot; &quot;4&quot; &quot;6&quot; &quot;8&quot;</span>
  <span class="token keyword">case</span> ch <span class="token operator">&lt;-</span> i<span class="token punctuation">:</span>     <span class="token comment">// i 为基数时不会执行这个 case, 所以上面的打印值都是偶数</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-go extra-class"><pre class="language-go"><code>ticker <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTicker</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
<span class="token operator">&lt;-</span>ticker<span class="token punctuation">.</span>C
ticker<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 停止发送事件</span>
</code></pre></div><h3 id="并发的目录遍历"><a href="#并发的目录遍历" aria-hidden="true" class="header-anchor">#</a> 并发的目录遍历</h3> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">var</span> verbose <span class="token operator">=</span> flag<span class="token punctuation">.</span><span class="token function">Bool</span><span class="token punctuation">(</span><span class="token string">&quot;v&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">&quot;show verbose progress messages&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> tick <span class="token operator">&lt;-</span><span class="token keyword">chan</span> time<span class="token punctuation">.</span>Time
    <span class="token keyword">if</span> <span class="token operator">*</span>verbose <span class="token punctuation">{</span>
        tick <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">Tick</span><span class="token punctuation">(</span><span class="token number">500</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span> <span class="token comment">// channel 每 0.5s 发出一个值</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> nfiles<span class="token punctuation">,</span> nbytes <span class="token builtin">int64</span>
loop<span class="token punctuation">:</span>
    <span class="token comment">// for 轮询 fileSizes 是否有发出值，及时消费</span>
    <span class="token keyword">for</span> <span class="token punctuation">{</span>
        <span class="token keyword">select</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> size<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token operator">&lt;-</span>fileSizes<span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
                <span class="token keyword">break</span> loop <span class="token comment">// 如果没有 loop 标签，只会跳出 select，这里要跳出 for 所以在外面打了一个 loop 标签</span>
            <span class="token punctuation">}</span>
            nfiles<span class="token operator">++</span>
            nbytes <span class="token operator">+=</span> size
        <span class="token keyword">case</span> <span class="token operator">&lt;-</span>tick<span class="token punctuation">:</span>
            <span class="token function">printDiskUsage</span><span class="token punctuation">(</span>nfiles<span class="token punctuation">,</span> nbytes<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">printDiskUsage</span><span class="token punctuation">(</span>nfiles<span class="token punctuation">,</span> nbytes<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="并发的退出"><a href="#并发的退出" aria-hidden="true" class="header-anchor">#</a> 并发的退出</h3> <p>广播机制：不要向 channel 发送值，而是用关闭一个 channel 来进行广播</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">var</span> done <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">cancelled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
    <span class="token keyword">select</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token operator">&lt;-</span>done<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">cancelled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 以此判断退出信号, 然后在 goroutine 里直接 return</span>
</code></pre></div><p>goroutine 结束时，在主函数里无法确认其已经释放了所有资源，
那我们不用 return 而是调用一个 panic ，
最后如果 main 是唯一剩下的 goroutine 话，他会清理掉自己的一切资源。</p> <h3 id="聊天服务"><a href="#聊天服务" aria-hidden="true" class="header-anchor">#</a> 聊天服务</h3> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	listener<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token string">&quot;tcp&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;localhost:8000&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
    <span class="token keyword">go</span> <span class="token function">broadcaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 轮询客户端的连接</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> listener<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">go</span> <span class="token function">handleConn</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> client <span class="token keyword">chan</span><span class="token operator">&lt;-</span> <span class="token builtin">string</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	entering <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> client<span class="token punctuation">)</span> <span class="token comment">// 值为 chan 类型的 chan 类型</span>
	leaving  <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> client<span class="token punctuation">)</span>
    messages <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">string</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token comment">// 轮询广播</span>
<span class="token keyword">func</span> <span class="token function">broadcaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    clients <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>client<span class="token punctuation">]</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token comment">// chan 类型的集合</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token keyword">select</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> msg <span class="token operator">:=</span> <span class="token operator">&lt;-</span>messages<span class="token punctuation">:</span>
			<span class="token keyword">for</span> cli <span class="token operator">:=</span> <span class="token keyword">range</span> clients <span class="token punctuation">{</span>
				cli <span class="token operator">&lt;-</span> msg <span class="token comment">// 消息广播给所有客户端</span>
			<span class="token punctuation">}</span>
		<span class="token keyword">case</span> cli <span class="token operator">:=</span> <span class="token operator">&lt;-</span>entering<span class="token punctuation">:</span>
			clients<span class="token punctuation">[</span>cli<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
		<span class="token keyword">case</span> cli <span class="token operator">:=</span> <span class="token operator">&lt;-</span>leaving<span class="token punctuation">:</span>
			<span class="token function">delete</span><span class="token punctuation">(</span>clients<span class="token punctuation">,</span> cli<span class="token punctuation">)</span>
			<span class="token function">close</span><span class="token punctuation">(</span>cli<span class="token punctuation">)</span> <span class="token comment">// 同时关闭 chan</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 处理客户端连接</span>
<span class="token keyword">func</span> <span class="token function">handleConn</span><span class="token punctuation">(</span>conn net<span class="token punctuation">.</span>Conn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">string</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">clientWriter</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> ch<span class="token punctuation">)</span>

	who <span class="token operator">:=</span> conn<span class="token punctuation">.</span><span class="token function">RemoteAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	ch <span class="token operator">&lt;-</span> <span class="token string">&quot;You are &quot;</span> <span class="token operator">+</span> who
	messages <span class="token operator">&lt;-</span> who <span class="token operator">+</span> <span class="token string">&quot; has arrived&quot;</span>
	entering <span class="token operator">&lt;-</span> ch <span class="token comment">// 记录客户端</span>

	input <span class="token operator">:=</span> bufio<span class="token punctuation">.</span><span class="token function">NewScanner</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span>
	<span class="token keyword">for</span> input<span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		messages <span class="token operator">&lt;-</span> who <span class="token operator">+</span> <span class="token string">&quot;: &quot;</span> <span class="token operator">+</span> input<span class="token punctuation">.</span><span class="token function">Text</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	leaving <span class="token operator">&lt;-</span> ch <span class="token comment">// 注销客户端</span>
	messages <span class="token operator">&lt;-</span> who <span class="token operator">+</span> <span class="token string">&quot; has left&quot;</span>
	conn<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">clientWriter</span><span class="token punctuation">(</span>conn net<span class="token punctuation">.</span>Conn<span class="token punctuation">,</span> ch <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> msg <span class="token operator">:=</span> <span class="token keyword">range</span> ch <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Fprintln</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> msg<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="基于共享变量的并发"><a href="#基于共享变量的并发" aria-hidden="true" class="header-anchor">#</a> 基于共享变量的并发</h2> <p>了解并发机制，解释 goroutine 和操作系统线程之间的技术上的一些区别</p> <h3 id="竞争条件"><a href="#竞争条件" aria-hidden="true" class="header-anchor">#</a> 竞争条件</h3> <p>数据竞争：只要有两个 goroutine 并发访问同一变量，且至少其中的一个是写操作的时候就会发生数据竞争</p> <p>并发并不是简单的语句交叉执行</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">var</span> x <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>
<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> x <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> x <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">1000000</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
x<span class="token punctuation">[</span><span class="token number">999999</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token comment">// NOTE: undefined behavior; memory corruption possible!</span>
</code></pre></div><p>如果 x 的指针从第一个 make 来，而长度从第二个 make 来，x 就变成了一个复合体，一个自称长度为 1000000 但实际上只有 10 个元素的 slice ，这会导致存储 999999 的位置碰撞一个遥远的内存位置</p> <p>不要使用共享数据来通信；使用通信来共享数据</p> <h3 id="sync-mutex-互斥锁"><a href="#sync-mutex-互斥锁" aria-hidden="true" class="header-anchor">#</a> sync.Mutex 互斥锁</h3> <p>在 Lock 和 Unlock 之间的代码段中的内容 goroutine 可以随便读取或者修改，这个代码段叫做临界区</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token string">&quot;sync&quot;</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	mu      sync<span class="token punctuation">.</span>Mutex
	balance <span class="token builtin">int</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">Withdraw</span><span class="token punctuation">(</span>amount <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">deposit</span><span class="token punctuation">(</span><span class="token operator">-</span>amount<span class="token punctuation">)</span>
	<span class="token keyword">if</span> balance <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token function">deposit</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Deposit</span><span class="token punctuation">(</span>amount <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">deposit</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Balance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> balance
<span class="token punctuation">}</span>

<span class="token comment">// 此函数要求 持有锁</span>
<span class="token keyword">func</span> <span class="token function">deposit</span><span class="token punctuation">(</span>amount <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> balance <span class="token operator">+=</span> amount <span class="token punctuation">}</span>
</code></pre></div><h3 id="sync-rwmutex-读写锁"><a href="#sync-rwmutex-读写锁" aria-hidden="true" class="header-anchor">#</a> sync.RWMutex 读写锁</h3> <p>多读单写锁</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">var</span> mu sync<span class="token punctuation">.</span>RWMutex
<span class="token keyword">var</span> balance <span class="token builtin">int</span>
<span class="token keyword">func</span> <span class="token function">Balance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	mu<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 读操作可以并行执行，在临界区的共享变量没有写操作时可用</span>
	<span class="token keyword">defer</span> mu<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> balance
<span class="token punctuation">}</span>
</code></pre></div><p>比一般的无竞争锁 mutex 慢一些</p> <h3 id="内存同步"><a href="#内存同步" aria-hidden="true" class="header-anchor">#</a> 内存同步</h3> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">var</span> x<span class="token punctuation">,</span> y <span class="token builtin">int</span>
<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	x <span class="token operator">=</span> <span class="token number">1</span> <span class="token comment">// A1</span>
	fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;y:&quot;</span><span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">)</span> <span class="token comment">// A2</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	y <span class="token operator">=</span> <span class="token number">1</span>                   <span class="token comment">// B1</span>
	fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;x:&quot;</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">)</span> <span class="token comment">// B2</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>x:0 y:0
y:0 x:0
</code></pre></div><p>如果两个 goroutine 在不同的 CPU 上执行，每一个核心有自己的缓存，这样一个 goroutine 的写入对于其它 goroutine 的 Print，在主存同步之前就是不可见的了</p> <p>cpu 自己的缓存 -&gt; 同步数据到内存</p> <h3 id="sync-once-惰性初始化"><a href="#sync-once-惰性初始化" aria-hidden="true" class="header-anchor">#</a> sync.Once 惰性初始化</h3> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">var</span> loadIconsOnce sync<span class="token punctuation">.</span>Once
<span class="token keyword">var</span> icons <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>image<span class="token punctuation">.</span>Image

<span class="token keyword">func</span> <span class="token function">loadIcons</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	icons <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>image<span class="token punctuation">.</span>Image<span class="token punctuation">{</span>
		<span class="token string">&quot;spades.png&quot;</span><span class="token punctuation">:</span>   <span class="token function">loadIcon</span><span class="token punctuation">(</span><span class="token string">&quot;spades.png&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token string">&quot;hearts.png&quot;</span><span class="token punctuation">:</span>   <span class="token function">loadIcon</span><span class="token punctuation">(</span><span class="token string">&quot;hearts.png&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token string">&quot;diamonds.png&quot;</span><span class="token punctuation">:</span> <span class="token function">loadIcon</span><span class="token punctuation">(</span><span class="token string">&quot;diamonds.png&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token string">&quot;clubs.png&quot;</span><span class="token punctuation">:</span>	<span class="token function">loadIcon</span><span class="token punctuation">(</span><span class="token string">&quot;clubs.png&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Icon</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span> image<span class="token punctuation">.</span>Image <span class="token punctuation">{</span>
	loadIconsOnce<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>loadIcons<span class="token punctuation">)</span> <span class="token comment">// Do 接收一个初始化函数</span>
	<span class="token keyword">return</span> icons<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样能避免变量在被构建完成之前和其他 goroutine 共享该变量</p> <h3 id="竞争条件检测"><a href="#竞争条件检测" aria-hidden="true" class="header-anchor">#</a> 竞争条件检测</h3> <p>使用 <code>-race</code> 参数，在运行期间对共享变量访问的 test</p> <div class="language-sh extra-class"><pre class="language-sh"><code>go build -race
</code></pre></div><h3 id="并发的非阻塞缓存"><a href="#并发的非阻塞缓存" aria-hidden="true" class="header-anchor">#</a> 并发的非阻塞缓存</h3> <p>？？？</p> <h3 id="goroutines-和线程"><a href="#goroutines-和线程" aria-hidden="true" class="header-anchor">#</a> Goroutines 和线程</h3> <p>goroutine 和线程的区别实际上只是一个量的区别</p> <p>一个 OS 线程都有一个固定大小的内存块（一般 2MB）来做栈，这个栈会用来存储当前正在被调用或挂起的函数的内部变量</p> <p>一个 goroutine 会以一个很小的栈（一般 2kb）开始其生命周期，栈的大小会根据需要动态伸缩（最大 1GB）—— 动态栈</p> <p>OS 线程会被操作系统内核调度 <strong>vs</strong> GO 运行包含了自己的调度器</p> <p>Go 调度器并不是用一个硬件定时器，而是被 Go 语言建筑本身进行调度的，这种调度方式不需要进入内核的上下文，所以重新调度一个 goroutine 比调度一个线程代价要低得多</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">for</span> <span class="token punctuation">{</span>
	<span class="token keyword">go</span> fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">go</span> 调度器使用了一个 GOMAXPROCS 变量来决定有多少个操作系统的线程同时执行 <span class="token keyword">go</span> 的代码

$ GOMAXPROCS<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">go</span> run hacker<span class="token operator">-</span>cliché<span class="token punctuation">.</span><span class="token keyword">go</span>
<span class="token number">111111111111111111110000000000000000000011111.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

$ GOMAXPROCS<span class="token operator">=</span><span class="token number">2</span> <span class="token keyword">go</span> run hacker<span class="token operator">-</span>cliché<span class="token punctuation">.</span><span class="token keyword">go</span>
<span class="token number">010101010101010101011001100101011010010100110.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p>OS 线程有一个 id 用于获取到值，Goroutine 没有 ID 号</p> <h2 id="包和工具"><a href="#包和工具" aria-hidden="true" class="header-anchor">#</a> 包和工具</h2> <h3 id="导入路径"><a href="#导入路径" aria-hidden="true" class="header-anchor">#</a> 导入路径</h3> <div class="language-Go extra-class"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span> <span class="token comment">// 1. 全局唯一导入路径</span>
	<span class="token string">&quot;math/rand&quot;</span> <span class="token comment">// 2. 包名就是路径的最后一段</span>
	crand <span class="token string">&quot;crypto/rand&quot;</span> <span class="token comment">// 3. 指定别名 crand 避免冲突</span>

	<span class="token string">&quot;golang.org/x/net/html&quot;</span> <span class="token comment">// 3. 建议非标准库以组织互联网域名为前缀</span>
	<span class="token string">&quot;gopkg.in/yaml.v2&quot;</span> <span class="token comment">// 4. 包名不包含 v2 版本后缀，所以包名是 yaml</span>
	<span class="token string">&quot;github.com/go-sql-driver/mysql&quot;</span>
<span class="token punctuation">)</span>
</code></pre></div><h3 id="导入路径-2"><a href="#导入路径-2" aria-hidden="true" class="header-anchor">#</a> 导入路径</h3> <p>每个 Go 语言源文件的开头都必须有包声明语句</p> <p>例如 <code>math/rand</code> 包的每个源文件的开头都包含 <code>package rand</code> 包声明语句，然后就可以使用 <code>rand.Int()</code></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rand<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>以 <code>_</code> 或 <code>.</code> 开头的源文件会被构建工具忽略</p> <p><code>main</code> 包是给 <code>go build</code>构建</p> <p><code>_test</code> 为后缀包名的测试外部扩展包 都由 go test 命令独立编译</p> <h3 id="包的匿名导入"><a href="#包的匿名导入" aria-hidden="true" class="header-anchor">#</a> 包的匿名导入</h3> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;image&quot;</span>
	<span class="token boolean">_</span> <span class="token string">&quot;image/jpeg&quot;</span>
	<span class="token boolean">_</span> <span class="token string">&quot;image/png&quot;</span> <span class="token comment">// 注册 PNG decoder</span>
<span class="token punctuation">)</span>
</code></pre></div><p>image 包拆分出了功能包，按需导入。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> png <span class="token comment">// image/png</span>

<span class="token keyword">func</span> <span class="token function">Decode</span><span class="token punctuation">(</span>r io<span class="token punctuation">.</span>Reader<span class="token punctuation">)</span> <span class="token punctuation">(</span>image<span class="token punctuation">.</span>Image<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">DecodeConfig</span><span class="token punctuation">(</span>r io<span class="token punctuation">.</span>Reader<span class="token punctuation">)</span> <span class="token punctuation">(</span>image<span class="token punctuation">.</span>Config<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>

<span class="token comment">// 注册</span>
<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> pngHeader <span class="token operator">=</span> <span class="token string">&quot;\x89PNG\r\n\x1a\n&quot;</span>
	image<span class="token punctuation">.</span><span class="token function">RegisterFormat</span><span class="token punctuation">(</span><span class="token string">&quot;png&quot;</span><span class="token punctuation">,</span> pngHeader<span class="token punctuation">,</span> Decode<span class="token punctuation">,</span> DecodeConfig<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="工具"><a href="#工具" aria-hidden="true" class="header-anchor">#</a> 工具</h3> <div class="language- extra-class"><pre class="language-text"><code>	build            compile packages and dependencies
	clean            remove object files
	doc              show documentation for package or symbol
	env              print Go environment information
	fmt              run gofmt on package sources
	get              download and install packages and dependencies
	install          compile and install packages and dependencies
	list             list packages
	run              compile and run Go program
	test             test packages
	version          print Go version
	vet              run go tool vet on packages
</code></pre></div><h3 id="工作区结构"><a href="#工作区结构" aria-hidden="true" class="header-anchor">#</a> 工作区结构</h3> <h3 id="下载包"><a href="#下载包" aria-hidden="true" class="header-anchor">#</a> 下载包</h3> <p><code>go get</code> 命令获取的代码是真实的本地存储仓库，可以使用版本管理工具切换到其他版本，例如 golang.org/x/net 包目录对应一个 Git 仓库</p> <p>指定 <code>-u</code> 参数，将拉取所有的包和依赖包，然后重新编译和安装他们</p> <p>使用 <code>vendor</code> 目录用于存储依赖包的固定版本的源代码</p> <h3 id="构建包"><a href="#构建包" aria-hidden="true" class="header-anchor">#</a> 构建包</h3> <p><code>go build</code> 编译参数指定的包和它依赖的包，如果包是库则忽略输出结果，如果是 main 则调用连接器在当前目录创建一个可执行程序</p> <p>每个目录只包含一个包</p> <div class="language- extra-class"><pre class="language-text"><code>$ cd $GOPATH/src/gopl.io/ch1/helloworld
$ go build
</code></pre></div><p>绝对路径</p> <div class="language- extra-class"><pre class="language-text"><code>$ cd anywhere
$ go build gopl.io/ch1/helloworld
</code></pre></div><p>相对路径</p> <div class="language- extra-class"><pre class="language-text"><code>$ cd $GOPATH
$ go build ./src/gopl.io/ch1/helloworld
</code></pre></div><p><code>go run</code> 命令结合了<code>构建</code>和<code>运行</code></p> <p><code>go install</code>命令和<code>go build</code>命令很相似，但是它会保存每个包的编译成果，而不是将它们都丢弃</p> <p>被编译的包会被保存到<code>$GOPATH/pkg</code>目录下，目录路径和<code>src</code>目录路径对应，可执行程序被保存到<code>$GOPATH/bin</code>目录</p> <p><code>go build -i</code>命令将安装每个目标所依赖的包</p> <p>构建约束</p> <p>在包声明和包注释的前面，该构建注释参数告诉<code>go build</code>只在编译程序对应的目标操作系统是 Linux 或 Mac OS X 时才编译这个文件</p> <div class="language-Go extra-class"><pre class="language-go"><code><span class="token comment">// +build linux darwin</span>
</code></pre></div><p>表示不编译这个文件：</p> <div class="language-Go extra-class"><pre class="language-go"><code><span class="token comment">// +build ignore</span>
</code></pre></div><h3 id="包文档"><a href="#包文档" aria-hidden="true" class="header-anchor">#</a> 包文档</h3> <p><code>go doc</code> 打印指定实体的注释与文档注释，实体可以是一个包 or 包的成员</p> <div class="language-sh extra-class"><pre class="language-sh"><code>go doc <span class="token function">time</span>

go doc time.Since

</code></pre></div><p>在线文档 <a href="https://godoc.org/fmt" target="_blank" rel="noopener noreferrer">https://godoc.org/fmt<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="内部包"><a href="#内部包" aria-hidden="true" class="header-anchor">#</a> 内部包</h3> <p>一个 internal 包只能被和 internal 目录有同一个父目录的包所导入</p> <p>例如 <code>net/http</code>/internal/chunked 内部包只能被 net/http/httputil 或 net/http 包导入，但是不能被 net/url 包导入</p> <div class="language- extra-class"><pre class="language-text"><code>net/url
net/http
net/http/httputil
net/http/internal/chunked
</code></pre></div><h3 id="查询包"><a href="#查询包" aria-hidden="true" class="header-anchor">#</a> 查询包</h3> <p><code>go list</code> 查询包的信息，打印导入路径</p> <p><code>go list ...</code> 列出工作区的所有包</p> <p><code>go list file/...</code> 指定目录下的包</p> <p><code>go list ...file...</code> 相关的包（类似关键词搜索）</p> <p><code>go list -json hash</code> 以 json 展示包的元信息</p> <h2 id="测试"><a href="#测试" aria-hidden="true" class="header-anchor">#</a> 测试</h2> <p><code>*_test.go</code> build 时不会被构建，包含：测试函数、基准测试（benchmark）函数、示例函数</p> <p>测试函数：以 Test 为函数名前缀，<code>go test</code> 会调用测试函数并报告测试结果 PASS 或 FAIL</p> <p>基准测试：以 Benchmark 为函数名前缀，<code>go test</code> 会多次运行基准测试函数以计算一个平均执行时间</p> <p>示例函数：以 Example 为函数名前缀，提供一个由编译器保证正确性的示例文档</p> <div class="language-Go extra-class"><pre class="language-go"><code><span class="token comment">// Package word provides utilities for word games.</span>
<span class="token keyword">package</span> word

<span class="token keyword">func</span> <span class="token function">IsPalindrome</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> s <span class="token punctuation">{</span>
		<span class="token keyword">if</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> s<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>i<span class="token punctuation">]</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在相同目录下创建 word_test.go 测试文件</p> <div class="language-Go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> word

<span class="token comment">// 引入 testing 包</span>
<span class="token keyword">import</span> <span class="token string">&quot;testing&quot;</span>

<span class="token keyword">func</span> <span class="token function">TestPalindrome</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">IsPalindrome</span><span class="token punctuation">(</span><span class="token string">&quot;detartrated&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 报告失败信息</span>
		t<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">`IsPalindrome(&quot;detartrated&quot;) = false`</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">IsPalindrome</span><span class="token punctuation">(</span><span class="token string">&quot;kayak&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">`IsPalindrome(&quot;kayak&quot;) = false`</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestNonPalindrome</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token function">IsPalindrome</span><span class="token punctuation">(</span><span class="token string">&quot;palindrome&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">`IsPalindrome(&quot;palindrome&quot;) = true`</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>go test -v</code> 打印每个测试函数名和运行时间</p> <p><code>go test -v -run=&quot;French|Canal&quot;</code> run 使用正则匹配需要测试的函数</p> <h3 id="随机测试"><a href="#随机测试" aria-hidden="true" class="header-anchor">#</a> 随机测试</h3> <h3 id="白盒测试"><a href="#白盒测试" aria-hidden="true" class="header-anchor">#</a> 白盒测试</h3> <p>黑盒测试：只测试包公开的文档和 api</p> <p>白盒测试：可以操作访问包内部函数和数据（测试函数注意保存和恢复全局变量）</p> <h3 id="外部测试包"><a href="#外部测试包" aria-hidden="true" class="header-anchor">#</a> 外部测试包</h3> <h3 id="测试覆盖率"><a href="#测试覆盖率" aria-hidden="true" class="header-anchor">#</a> 测试覆盖率</h3> <p>在测试中至少被运行一次的代码占总代码数的比例</p> <h3 id="基准测试"><a href="#基准测试" aria-hidden="true" class="header-anchor">#</a> 基准测试</h3> <div class="language-Go extra-class"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token string">&quot;testing&quot;</span>

<span class="token keyword">func</span> <span class="token function">BenchmarkIsPalindrome</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token function">IsPalindrome</span><span class="token punctuation">(</span><span class="token string">&quot;A man, a plan, a canal: Panama&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>go test -bench=.</code> 运行基准测试</p> <p><code>go test -bench=. -benchmem</code> 打印内存使用报告</p> <h3 id="剖析"><a href="#剖析" aria-hidden="true" class="header-anchor">#</a> 剖析</h3> <p><code>go test -cpuprofile=cpu.out</code> CPU 剖析数据 - 标识了最耗 CPU 时间的函数</p> <p><code>go test -blockprofile=block.out</code> 堆剖析 - 标识了最耗内存的语句</p> <p><code>go test -memprofile=mem.out</code> 阻塞剖析 - 记录阻塞 goroutine 最久的操作</p> <p>go test -run=NONE -bench=ClientServerParallelTLS64 -cpuprofile=cpu.log net/http</p> <p>-run=NONE 禁止基准测试</p> <p>分析日志
go tool pprof -text -nodecount=10 ./http.test cpu.log</p> <p>-text 指定输出格式</p> <h3 id="示例函数"><a href="#示例函数" aria-hidden="true" class="header-anchor">#</a> 示例函数</h3> <p>以 Example 开头，没有参数和返回值，可作为文档，是真实的 go 代码</p> <p>go test 会执行示例函数，并检查输出与注释<code>Output</code>是否一致</p> <div class="language-Go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">ExampleIsPalindrome</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">IsPalindrome</span><span class="token punctuation">(</span><span class="token string">&quot;A man, a plan, a canal: Panama&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">IsPalindrome</span><span class="token punctuation">(</span><span class="token string">&quot;palindrome&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// true</span>
	<span class="token comment">// false</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="反射"><a href="#反射" aria-hidden="true" class="header-anchor">#</a> 反射</h2> <blockquote><p>很少需要用到</p></blockquote> <p>reflect 能在运行时更新变量和检查它们的值、调用它们的方法和它们支持的内在操作，而不需要在编译时知道这些变量的类型</p> <p>反射是一个复杂的内省技术，不应随意使用</p> <h2 id="底层编程"><a href="#底层编程" aria-hidden="true" class="header-anchor">#</a> 底层编程</h2> <blockquote><p>很少需要用到</p></blockquote> <p>unsafe</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.da05fdbf.js" defer></script><script src="/assets/js/2.208295da.js" defer></script><script src="/assets/js/33.362b0b71.js" defer></script><script src="/assets/js/5.b3cdef39.js" defer></script>
  </body>
</html>
